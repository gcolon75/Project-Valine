# Project Valine - Staging Environment Configuration
# For first account creation and testing
# See: docs/release/STAGING_FIRST_ACCOUNT.md

# ============================================
# REQUIRED: Database
# ============================================
DATABASE_URL=postgresql://USER:PASSWORD@HOST:PORT/DATABASE

# ============================================
# REQUIRED: JWT Authentication
# ============================================
JWT_SECRET=your-secure-random-jwt-secret-at-least-32-chars-CHANGE-THIS

# ============================================
# REQUIRED: Frontend Configuration
# ============================================
FRONTEND_URL=https://staging.projectvaline.com
COOKIE_DOMAIN=.projectvaline.com  # Note: leading dot for cross-subdomain
NODE_ENV=production
STAGE=staging

# ============================================
# REQUIRED: Email Verification (CRITICAL)
# ============================================
# Must be enabled for account creation to work
EMAIL_ENABLED=true

# SMTP Configuration (SendGrid example - replace with your provider)
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=SG.your-sendgrid-api-key-here
FROM_EMAIL=noreply@projectvaline.com

# For testing without SMTP, set EMAIL_ENABLED=false
# Verification tokens will be logged to console instead

# ============================================
# REQUIRED: Rate Limiting (CRITICAL)
# ============================================
# Must be enabled to prevent abuse
RATE_LIMITING_ENABLED=true
REDIS_URL=redis://your-redis-host:6379

# If Redis is unavailable, rate limiting falls back to in-memory
# (resets on server restart - not recommended for production)

# ============================================
# Security Features - Enable After Initial Testing
# ============================================
# Enable 2FA after initial account creation succeeds
TWO_FACTOR_ENABLED=false

# Enable CSRF when frontend sends X-CSRF-Token header
CSRF_ENABLED=false

# ============================================
# AWS Configuration (if using S3 for uploads)
# ============================================
AWS_REGION=us-west-2
S3_BUCKET=valine-uploads-staging
MEDIA_BUCKET=valine-media-uploads-staging

# ============================================
# Optional: Feature Flags (disable for initial testing)
# ============================================
PR_INTEL_ENABLED=false
PR_INTEL_WEBHOOK_SECRET=

FLAKY_DETECTOR_ENABLED=false
SCHEMA_DIFF_ENABLED=false
SYNTHETIC_JOURNEY_ENABLED=false
API_BASE_URL=https://api.staging.projectvaline.com

# ============================================
# Cognito (if using AWS Cognito - optional)
# ============================================
COGNITO_POOL_ID=
COGNITO_REGION=us-west-2
COGNITO_CLIENT_ID=

# ============================================
# Security Checklist
# ============================================
# Before deploying to staging, verify:
# [x] JWT_SECRET is a strong random string (32+ chars)
# [x] EMAIL_ENABLED=true with valid SMTP credentials
# [x] RATE_LIMITING_ENABLED=true with Redis configured
# [x] FRONTEND_URL and COOKIE_DOMAIN match your staging domain
# [x] DATABASE_URL points to staging database (NOT production!)
# [x] All three migrations applied (run: npx prisma migrate deploy)
#
# After successful first account:
# [ ] Consider enabling TWO_FACTOR_ENABLED=true
# [ ] Enable CSRF_ENABLED=true when frontend ready
# [ ] Review rate limiting logs for abuse patterns
# [ ] Rotate JWT_SECRET on a regular schedule

# ============================================
# Testing Commands
# ============================================
# Verify migrations:
#   ./verify-migration.sh
#
# Apply migrations:
#   npx prisma migrate deploy
#
# Test endpoints:
#   ./test-staging-account-creation.sh https://api.staging.projectvaline.com
#
# Check migration status:
#   npx prisma migrate status
