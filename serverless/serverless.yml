service: pv-api
frameworkVersion: "3"

plugins:
  - serverless-esbuild

provider:
  name: aws
  runtime: nodejs20.x
  region: ${env:AWS_REGION, "us-west-2"}
  stage: ${env:STAGE, "prod"}
  versionFunctions: false
  layers:
    - { Ref: PrismaLambdaLayer }
  httpApi:
    cors:
      allowedOrigins:
        - https://dkmxy676d3vgc.cloudfront.net
        - http://localhost:5173
        - http://localhost:3000
      allowedHeaders:
        - Content-Type
        - Authorization
        - X-CSRF-Token
        - X-Requested-With
      allowedMethods:
        - GET
        - POST
        - PUT
        - PATCH
        - DELETE
        - OPTIONS
      allowCredentials: true
      maxAge: 86400  # Cache preflight requests for 24 hours
  environment:
    STAGE: ${env:STAGE, "prod"}
    DATABASE_URL: ${env:DATABASE_URL}
    MEDIA_BUCKET: ${env:MEDIA_BUCKET, "valine-media-uploads"}
    JWT_SECRET: ${env:JWT_SECRET}
    EMAIL_ENABLED: ${env:EMAIL_ENABLED, "false"}
    TWO_FACTOR_ENABLED: ${env:TWO_FACTOR_ENABLED, "false"}
    CSRF_ENABLED: ${env:CSRF_ENABLED, "false"}
    ENABLE_REGISTRATION: ${env:ENABLE_REGISTRATION, "true"}
    ALLOWED_USER_EMAILS: ${env:ALLOWED_USER_EMAILS, "ghawk075@gmail.com,valinejustin@gmail.com"}
    PR_INTEL_ENABLED: ${env:PR_INTEL_ENABLED, "false"}
    PR_INTEL_WEBHOOK_SECRET: ${env:PR_INTEL_WEBHOOK_SECRET, ""}
    FLAKY_DETECTOR_ENABLED: ${env:FLAKY_DETECTOR_ENABLED, "false"}
    SCHEMA_DIFF_ENABLED: ${env:SCHEMA_DIFF_ENABLED, "false"}
    SYNTHETIC_JOURNEY_ENABLED: ${env:SYNTHETIC_JOURNEY_ENABLED, "false"}
    SYNTHETIC_USE_REAL_REQUESTS: ${env:SYNTHETIC_USE_REAL_REQUESTS, "true"}
    OBSERVABILITY_ENABLED: ${env:OBSERVABILITY_ENABLED, "true"}
    API_BASE_URL: ${env:API_BASE_URL, "https://i72dxlcfcc.execute-api.us-west-2.amazonaws.com"}
    FRONTEND_URL: ${env:FRONTEND_URL, "https://dkmxy676d3vgc.cloudfront.net"}
    NODE_ENV: ${env:NODE_ENV, "production"}
    COOKIE_DOMAIN: ${env:COOKIE_DOMAIN, ".cloudfront.net"}
    REDIS_URL: ${env:REDIS_URL, ""}
    RATE_LIMITING_ENABLED: ${env:RATE_LIMITING_ENABLED, "true"}
    MODERATION_ENABLED: ${env:MODERATION_ENABLED, "false"}
    MODERATION_ALERTS_ENABLED: ${env:MODERATION_ALERTS_ENABLED, "false"}
    MODERATION_STRICT_MODE: ${env:MODERATION_STRICT_MODE, "false"}
    REPORTS_ENABLED: ${env:REPORTS_ENABLED, "true"}
    MODERATION_ALERT_CHANNEL_ID: ${env:MODERATION_ALERT_CHANNEL_ID, ""}
    ADMIN_ROLE_IDS: ${env:ADMIN_ROLE_IDS, ""}
    REPORTS_MAX_PER_HOUR: ${env:REPORTS_MAX_PER_HOUR, "5"}
    REPORTS_MAX_PER_DAY: ${env:REPORTS_MAX_PER_DAY, "20"}
    REPORTS_IP_MAX_PER_HOUR: ${env:REPORTS_IP_MAX_PER_HOUR, "10"}
    URL_ALLOWED_DOMAINS: ${env:URL_ALLOWED_DOMAINS, "imdb.com,youtube.com,vimeo.com,linkedin.com,github.com"}
    URL_BLOCKED_DOMAINS: ${env:URL_BLOCKED_DOMAINS, ""}
    URL_ALLOWED_PROTOCOLS: ${env:URL_ALLOWED_PROTOCOLS, "http:https:mailto:"}
    PROFANITY_LIST_PATH: ${env:PROFANITY_LIST_PATH, ""}
    PROFANITY_ACTION: ${env:PROFANITY_ACTION, "block"}
    REPORT_CATEGORY_ALLOWLIST: ${env:REPORT_CATEGORY_ALLOWLIST, "spam,abuse,unsafe_link,profanity,privacy,other"}
    ANALYTICS_ENABLED: ${env:ANALYTICS_ENABLED, "false"}
    ANALYTICS_REQUIRE_CONSENT: ${env:ANALYTICS_REQUIRE_CONSENT, "true"}
    ANALYTICS_STORAGE_DRIVER: ${env:ANALYTICS_STORAGE_DRIVER, "postgres"}
    ANALYTICS_RETENTION_DAYS: ${env:ANALYTICS_RETENTION_DAYS, "30"}
    ANALYTICS_ALLOWED_EVENTS: ${env:ANALYTICS_ALLOWED_EVENTS, "page_view,signup,login,profile_update,media_upload,logout"}
    ANALYTICS_SAMPLING_RATE: ${env:ANALYTICS_SAMPLING_RATE, "1.0"}
    ANALYTICS_CONSENT_COOKIE: ${env:ANALYTICS_CONSENT_COOKIE, "analytics_consent"}
    STRICT_ALLOWLIST: ${env:STRICT_ALLOWLIST, "0"}
    ADMIN_SEED_TOKEN: ${env:ADMIN_SEED_TOKEN, ""}

custom:
  esbuild:
    bundle: true
    minify: true
    sourcemap: false
    platform: node
    target: node20
    concurrency: 1
    external:
      - aws-sdk
      - '@prisma/client'
      - '.prisma/client'
    exclude:
      - '@prisma/client'
      - '.prisma/client'
    keepOutputDirectory: true

layers:
  prisma:
    package:
      artifact: layers/prisma-layer.zip

package:
  individually: true
  excludeDevDependencies: true
  patterns:
    - '!**/*.map'
    - '!**/tests/**'
    - '!**/__tests__/**'
    - '!**/*.md'
    - '!**/.git/**'
    - '!**/.vscode/**'

functions:
  health:
    handler: src/handlers/health.handler
    events:
      - httpApi:
          path: /health
          method: get
  meta:
    handler: src/handlers/meta.handler
    events:
      - httpApi:
          path: /meta
          method: get
  
  # ========== AUTH ==========
  register:
    handler: src/handlers/auth.register
    events:
      - httpApi:
          path: /auth/register
          method: post
  login:
    handler: src/handlers/auth.login
    events:
      - httpApi:
          path: /auth/login
          method: post
  me:
    handler: src/handlers/auth.me
    events:
      - httpApi:
          path: /auth/me
          method: get
  verifyEmail:
    handler: src/handlers/auth.verifyEmail
    events:
      - httpApi:
          path: /auth/verify-email
          method: post
  resendVerification:
    handler: src/handlers/auth.resendVerification
    events:
      - httpApi:
          path: /auth/resend-verification
          method: post
  refresh:
    handler: src/handlers/auth.refresh
    events:
      - httpApi:
          path: /auth/refresh
          method: post
  logout:
    handler: src/handlers/auth.logout
    events:
      - httpApi:
          path: /auth/logout
          method: post
  setup2FA:
    handler: src/handlers/auth.setup2FA
    events:
      - httpApi:
          path: /auth/2fa/setup
          method: post
  enable2FA:
    handler: src/handlers/auth.enable2FA
    events:
      - httpApi:
          path: /auth/2fa/enable
          method: post
  verify2FA:
    handler: src/handlers/auth.verify2FA
    events:
      - httpApi:
          path: /auth/2fa/verify
          method: post
  disable2FA:
    handler: src/handlers/auth.disable2FA
    events:
      - httpApi:
          path: /auth/2fa/disable
          method: post
  seedRestricted:
    handler: src/handlers/auth.seedRestricted
    events:
      - httpApi:
          path: /auth/seed-restricted
          method: post

  # ========== USERS ==========
  createUser:
    handler: src/handlers/users.createUser
    events:
      - httpApi:
          path: /users
          method: post
  getUser:
    handler: src/handlers/users.getUser
    events:
      - httpApi:
          path: /users/{username}
          method: get
  updateUser:
    handler: src/handlers/users.updateUser
    events:
      - httpApi:
          path: /users/{id}
          method: put

  # ========== REELS ==========
  listReels:
    handler: src/handlers/reels.listReels
    events:
      - httpApi:
          path: /reels
          method: get
  createReel:
    handler: src/handlers/reels.createReel
    events:
      - httpApi:
          path: /reels
          method: post
  toggleLike:
    handler: src/handlers/reels.toggleLike
    events:
      - httpApi:
          path: /reels/{id}/like
          method: post
  toggleBookmark:
    handler: src/handlers/reels.toggleBookmark
    events:
      - httpApi:
          path: /reels/{id}/bookmark
          method: post
  getReelComments:
    handler: src/handlers/reels.getComments
    events:
      - httpApi:
          path: /reels/{id}/comments
          method: get
  createReelComment:
    handler: src/handlers/reels.createComment
    events:
      - httpApi:
          path: /reels/{id}/comments
          method: post

  # ========== POSTS ==========
  createPost:
    handler: src/handlers/posts.createPost
    events:
      - httpApi:
          path: /posts
          method: post
  listPosts:
    handler: src/handlers/posts.listPosts
    events:
      - httpApi:
          path: /posts
          method: get
  getPost:
    handler: src/handlers/posts.getPost
    events:
      - httpApi:
          path: /posts/{id}
          method: get

  # ========== CONVERSATIONS ==========
  listConversations:
    handler: src/handlers/conversations.listConversations
    events:
      - httpApi:
          path: /conversations
          method: get
  createConversation:
    handler: src/handlers/conversations.createConversation
    events:
      - httpApi:
          path: /conversations
          method: post
  getMessages:
    handler: src/handlers/conversations.getMessages
    events:
      - httpApi:
          path: /conversations/{id}/messages
          method: get
  sendMessage:
    handler: src/handlers/conversations.sendMessage
    events:
      - httpApi:
          path: /conversations/{id}/messages
          method: post

  # ========== NOTIFICATIONS ==========
  listNotifications:
    handler: src/handlers/notifications.listNotifications
    events:
      - httpApi:
          path: /notifications
          method: get
  markNotificationRead:
    handler: src/handlers/notifications.markAsRead
    events:
      - httpApi:
          path: /notifications/{id}/read
          method: patch
  markAllNotificationsRead:
    handler: src/handlers/notifications.markAllAsRead
    events:
      - httpApi:
          path: /notifications/mark-all
          method: patch
  
  # ========== NEW: UNREAD COUNTS ==========
  getUnreadCounts:
    handler: src/handlers/notifications.getUnreadCounts
    events:
      - httpApi:
          path: /unread-counts
          method: get

  # ========== CONNECTIONS ==========
  sendConnectionRequest:
    handler: src/handlers/connections.sendRequest
    events:
      - httpApi:
          path: /connections/request
          method: post
  listConnectionRequests:
    handler: src/handlers/connections.listRequests
    events:
      - httpApi:
          path: /connections/requests
          method: get
  approveConnectionRequest:
    handler: src/handlers/connections.approveRequest
    events:
      - httpApi:
          path: /connections/requests/{id}/approve
          method: post
  rejectConnectionRequest:
    handler: src/handlers/connections.rejectRequest
    events:
      - httpApi:
          path: /connections/requests/{id}/reject
          method: post
  followUser:
    handler: src/handlers/connections.followUser
    events:
      - httpApi:
          path: /connections/follow
          method: post
  getConnectionStatus:
    handler: src/handlers/connections.getConnectionStatus
    events:
      - httpApi:
          path: /connections/status/{userId}
          method: get

  # ========== PROFILES ==========
  getProfileByVanity:
    handler: src/handlers/profiles.getProfileByVanity
    events:
      - httpApi:
          path: /profiles/{vanityUrl}
          method: get
  getProfileById:
    handler: src/handlers/profiles.getProfileById
    events:
      - httpApi:
          path: /profiles/id/{id}
          method: get
  createProfile:
    handler: src/handlers/profiles.createProfile
    events:
      - httpApi:
          path: /profiles
          method: post
  updateProfile:
    handler: src/handlers/profiles.updateProfile
    events:
      - httpApi:
          path: /profiles/id/{id}
          method: put
  updateMyProfile:
    handler: src/handlers/profiles.updateMyProfile
    events:
      - httpApi:
          path: /me/profile
          method: patch
  getMyProfile:
    handler: src/handlers/profiles.getMyProfile
    events:
      - httpApi:
          path: /me/profile
          method: get
  deleteProfile:
    handler: src/handlers/profiles.deleteProfile
    events:
      - httpApi:
          path: /profiles/id/{id}
          method: delete

  # ========== MEDIA ==========
  getUploadUrl:
    handler: src/handlers/media.getUploadUrl
    events:
      - httpApi:
          path: /profiles/{id}/media/upload-url
          method: post
  completeUpload:
    handler: src/handlers/media.completeUpload
    events:
      - httpApi:
          path: /profiles/{id}/media/complete
          method: post
  updateMedia:
    handler: src/handlers/media.updateMedia
    events:
      - httpApi:
          path: /media/{id}
          method: put
  deleteMedia:
    handler: src/handlers/media.deleteMedia
    events:
      - httpApi:
          path: /media/{id}
          method: delete
  getAccessUrl:
    handler: src/handlers/media.getAccessUrl
    events:
      - httpApi:
          path: /media/{id}/access-url
          method: get

  # ========== CREDITS ==========
  listCredits:
    handler: src/handlers/credits.listCredits
    events:
      - httpApi:
          path: /profiles/{id}/credits
          method: get
  createCredit:
    handler: src/handlers/credits.createCredit
    events:
      - httpApi:
          path: /profiles/{id}/credits
          method: post
  updateCredit:
    handler: src/handlers/credits.updateCredit
    events:
      - httpApi:
          path: /credits/{id}
          method: put
  deleteCredit:
    handler: src/handlers/credits.deleteCredit
    events:
      - httpApi:
          path: /credits/{id}
          method: delete

  # ========== SETTINGS ==========
  getSettings:
    handler: src/handlers/settings.getSettings
    events:
      - httpApi:
          path: /settings
          method: get
  updateSettings:
    handler: src/handlers/settings.updateSettings
    events:
      - httpApi:
          path: /settings
          method: put
  exportAccountData:
    handler: src/handlers/settings.exportAccountData
    events:
      - httpApi:
          path: /account/export
          method: post
  deleteAccount:
    handler: src/handlers/settings.deleteAccount
    events:
      - httpApi:
          path: /account
          method: delete
  getPreferences:
    handler: src/handlers/settings.getPreferences
    events:
      - httpApi:
          path: /me/preferences
          method: get
  updatePreferences:
    handler: src/handlers/settings.updatePreferences
    events:
      - httpApi:
          path: /me/preferences
          method: put

  # ========== REEL REQUESTS ==========
  createReelRequest:
    handler: src/handlers/reelRequests.createReelRequest
    events:
      - httpApi:
          path: /reels/{id}/request
          method: post
  listReelRequests:
    handler: src/handlers/reelRequests.listReelRequests
    events:
      - httpApi:
          path: /reel-requests
          method: get
  approveReelRequest:
    handler: src/handlers/reelRequests.approveReelRequest
    events:
      - httpApi:
          path: /reel-requests/{id}/approve
          method: post
  denyReelRequest:
    handler: src/handlers/reelRequests.denyReelRequest
    events:
      - httpApi:
          path: /reel-requests/{id}/deny
          method: post

  # ========== SEARCH ==========
  searchProfiles:
    handler: src/handlers/search.searchProfiles
    events:
      - httpApi:
          path: /search
          method: get
  searchUsers:
    handler: src/handlers/search.searchUsers
    events:
      - httpApi:
          path: /search/users
          method: get

  # ========== INTERNAL/ADMIN ==========
  ingestPRIntel:
    handler: src/handlers/prIntel.ingestPRIntel
    events:
      - httpApi:
          path: /internal/pr-intel/ingest
          method: post
  getPRIntel:
    handler: src/handlers/prIntel.getPRIntel
    events:
      - httpApi:
          path: /internal/pr-intel/{prNumber}
          method: get
  ingestTestRuns:
    handler: src/handlers/testIntel.ingestTestRuns
    events:
      - httpApi:
          path: /internal/tests/ingest
          method: post
  getFlakyCandidates:
    handler: src/handlers/testIntel.getFlakyCandidates
    events:
      - httpApi:
          path: /internal/tests/flaky-candidates
          method: get
  analyzeSchemaDiff:
    handler: src/handlers/schemaDiff.analyzeSchemaDiff
    events:
      - httpApi:
          path: /internal/schema/diff
          method: post
  runSyntheticJourney:
    handler: src/handlers/syntheticJourney.runSyntheticJourney
    events:
      - httpApi:
          path: /internal/journey/run
          method: post

  # ========== OBSERVABILITY ==========
  ingestMetrics:
    handler: src/handlers/observability.ingestMetrics
    events:
      - httpApi:
          path: /internal/observability/metrics
          method: post
  getMetrics:
    handler: src/handlers/observability.getMetrics
    events:
      - httpApi:
          path: /internal/observability/metrics
          method: get
  observabilityHealth:
    handler: src/handlers/observability.healthCheck
    events:
      - httpApi:
          path: /internal/observability/health
          method: get
  getStats:
    handler: src/handlers/observability.getStats
    events:
      - httpApi:
          path: /internal/observability/stats
          method: get
  logEvent:
    handler: src/handlers/observability.logEvent
    events:
      - httpApi:
          path: /internal/observability/log
          method: post

  # ========== REPORTS & MODERATION ==========
  createReport:
    handler: src/handlers/reports.createReport
    events:
      - httpApi:
          path: /reports
          method: post
  listReports:
    handler: src/handlers/reports.listReports
    events:
      - httpApi:
          path: /reports
          method: get
  getReport:
    handler: src/handlers/reports.getReport
    events:
      - httpApi:
          path: /reports/{id}
          method: get
  makeDecision:
    handler: src/handlers/moderation.makeDecision
    events:
      - httpApi:
          path: /moderation/decision
          method: post
  moderationHealth:
    handler: src/handlers/moderation.getHealth
    events:
      - httpApi:
          path: /moderation/health
          method: get

  # ========== ANALYTICS ==========
  analyticsIngest:
    handler: src/handlers/analytics.ingestEvents
    events:
      - httpApi:
          path: /analytics/ingest
          method: post
  analyticsConfig:
    handler: src/handlers/analytics.getConfig
    events:
      - httpApi:
          path: /analytics/config
          method: get
  analyticsCleanup:
    handler: src/handlers/analytics.cleanupOldEvents
    events:
      - httpApi:
          path: /analytics/events/cleanup
          method: delete