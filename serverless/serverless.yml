service: pv-api
frameworkVersion: "3"

provider:
  name: aws
  runtime: nodejs20.x
  region: ${env:AWS_REGION, "us-west-2"}
  stage: ${env:STAGE, "prod"}
  httpApi:
    cors: true
  environment:
    STAGE: ${env:STAGE, "prod"}
    DATABASE_URL: ${env:DATABASE_URL}
    MEDIA_BUCKET: ${env:MEDIA_BUCKET, "valine-media-uploads"}
    AWS_REGION: ${env:AWS_REGION, "us-west-2"}
    JWT_SECRET: ${env:JWT_SECRET}
    EMAIL_ENABLED: ${env:EMAIL_ENABLED, "false"}
    TWO_FACTOR_ENABLED: ${env:TWO_FACTOR_ENABLED, "false"}
    FRONTEND_URL: ${env:FRONTEND_URL, "http://localhost:5173"}
    NODE_ENV: ${env:NODE_ENV, "development"}
    COOKIE_DOMAIN: ${env:COOKIE_DOMAIN, ""}
    REDIS_URL: ${env:REDIS_URL, ""}
    RATE_LIMITING_ENABLED: ${env:RATE_LIMITING_ENABLED, "true"}

package:
  patterns:
    - '!.git/**'
    - '!.github/**'
    - '!*.md'
    - '!test/**'
    - '!tests/**'

functions:
  # Health & Meta endpoints
  health:
    handler: src/handlers/health.handler
    events:
      - httpApi:
          path: /health
          method: get
  
  meta:
    handler: src/handlers/meta.handler
    events:
      - httpApi:
          path: /meta
          method: get

  # Authentication endpoints
  register:
    handler: src/handlers/auth.register
    events:
      - httpApi:
          path: /auth/register
          method: post
  
  login:
    handler: src/handlers/auth.login
    events:
      - httpApi:
          path: /auth/login
          method: post
  
  me:
    handler: src/handlers/auth.me
    events:
      - httpApi:
          path: /auth/me
          method: get
  
  verifyEmail:
    handler: src/handlers/auth.verifyEmail
    events:
      - httpApi:
          path: /auth/verify-email
          method: post
  
  resendVerification:
    handler: src/handlers/auth.resendVerification
    events:
      - httpApi:
          path: /auth/resend-verification
          method: post
  
  refresh:
    handler: src/handlers/auth.refresh
    events:
      - httpApi:
          path: /auth/refresh
          method: post
  
  logout:
    handler: src/handlers/auth.logout
    events:
      - httpApi:
          path: /auth/logout
          method: post

  # Session management endpoints (Phase 2)
  listSessions:
    handler: src/handlers/sessions.listSessions
    events:
      - httpApi:
          path: /auth/sessions
          method: get

  logoutSession:
    handler: src/handlers/sessions.logoutSession
    events:
      - httpApi:
          path: /auth/logout-session
          method: post

  # 2FA endpoints (Phase 2)
  setup2FA:
    handler: src/handlers/auth.setup2FA
    events:
      - httpApi:
          path: /auth/2fa/setup
          method: post

  enable2FA:
    handler: src/handlers/auth.enable2FA
    events:
      - httpApi:
          path: /auth/2fa/enable
          method: post

  verify2FA:
    handler: src/handlers/auth.verify2FA
    events:
      - httpApi:
          path: /auth/2fa/verify
          method: post

  disable2FA:
    handler: src/handlers/auth.disable2FA
    events:
      - httpApi:
          path: /auth/2fa/disable
          method: post

  # User endpoints
  createUser:
    handler: src/handlers/users.createUser
    events:
      - httpApi:
          path: /users
          method: post
  
  getUser:
    handler: src/handlers/users.getUser
    events:
      - httpApi:
          path: /users/{username}
          method: get
  
  updateUser:
    handler: src/handlers/users.updateUser
    events:
      - httpApi:
          path: /users/{id}
          method: put
  
  # Reels endpoints
  listReels:
    handler: src/handlers/reels.listReels
    events:
      - httpApi:
          path: /reels
          method: get
  
  createReel:
    handler: src/handlers/reels.createReel
    events:
      - httpApi:
          path: /reels
          method: post
  
  toggleLike:
    handler: src/handlers/reels.toggleLike
    events:
      - httpApi:
          path: /reels/{id}/like
          method: post
  
  toggleBookmark:
    handler: src/handlers/reels.toggleBookmark
    events:
      - httpApi:
          path: /reels/{id}/bookmark
          method: post
  
  getReelComments:
    handler: src/handlers/reels.getComments
    events:
      - httpApi:
          path: /reels/{id}/comments
          method: get
  
  createReelComment:
    handler: src/handlers/reels.createComment
    events:
      - httpApi:
          path: /reels/{id}/comments
          method: post
  
  # Post endpoints (legacy)
  createPost:
    handler: src/handlers/posts.createPost
    events:
      - httpApi:
          path: /posts
          method: post
  
  listPosts:
    handler: src/handlers/posts.listPosts
    events:
      - httpApi:
          path: /posts
          method: get
  
  getPost:
    handler: src/handlers/posts.getPost
    events:
      - httpApi:
          path: /posts/{id}
          method: get
  
  # Conversation endpoints
  listConversations:
    handler: src/handlers/conversations.listConversations
    events:
      - httpApi:
          path: /conversations
          method: get
  
  createConversation:
    handler: src/handlers/conversations.createConversation
    events:
      - httpApi:
          path: /conversations
          method: post
  
  getMessages:
    handler: src/handlers/conversations.getMessages
    events:
      - httpApi:
          path: /conversations/{id}/messages
          method: get
  
  sendMessage:
    handler: src/handlers/conversations.sendMessage
    events:
      - httpApi:
          path: /conversations/{id}/messages
          method: post
  
  # Notification endpoints
  listNotifications:
    handler: src/handlers/notifications.listNotifications
    events:
      - httpApi:
          path: /notifications
          method: get
  
  markNotificationRead:
    handler: src/handlers/notifications.markAsRead
    events:
      - httpApi:
          path: /notifications/{id}/read
          method: patch
  
  markAllNotificationsRead:
    handler: src/handlers/notifications.markAllAsRead
    events:
      - httpApi:
          path: /notifications/mark-all
          method: patch
  
  # Connection endpoints
  sendConnectionRequest:
    handler: src/handlers/connections.sendRequest
    events:
      - httpApi:
          path: /connections/request
          method: post
  
  listConnectionRequests:
    handler: src/handlers/connections.listRequests
    events:
      - httpApi:
          path: /connections/requests
          method: get
  
  approveConnectionRequest:
    handler: src/handlers/connections.approveRequest
    events:
      - httpApi:
          path: /connections/requests/{id}/approve
          method: post
  
  rejectConnectionRequest:
    handler: src/handlers/connections.rejectRequest
    events:
      - httpApi:
          path: /connections/requests/{id}/reject
          method: post

  # Profile endpoints
  getProfileByVanity:
    handler: src/handlers/profiles.getProfileByVanity
    events:
      - httpApi:
          path: /profiles/{vanityUrl}
          method: get
  
  getProfileById:
    handler: src/handlers/profiles.getProfileById
    events:
      - httpApi:
          path: /profiles/id/{id}
          method: get
  
  createProfile:
    handler: src/handlers/profiles.createProfile
    events:
      - httpApi:
          path: /profiles
          method: post
  
  updateProfile:
    handler: src/handlers/profiles.updateProfile
    events:
      - httpApi:
          path: /profiles/id/{id}
          method: put
  
  deleteProfile:
    handler: src/handlers/profiles.deleteProfile
    events:
      - httpApi:
          path: /profiles/id/{id}
          method: delete

  # Media endpoints
  getUploadUrl:
    handler: src/handlers/media.getUploadUrl
    events:
      - httpApi:
          path: /profiles/{id}/media/upload-url
          method: post
  
  completeUpload:
    handler: src/handlers/media.completeUpload
    events:
      - httpApi:
          path: /profiles/{id}/media/complete
          method: post
  
  updateMedia:
    handler: src/handlers/media.updateMedia
    events:
      - httpApi:
          path: /media/{id}
          method: put
  
  deleteMedia:
    handler: src/handlers/media.deleteMedia
    events:
      - httpApi:
          path: /media/{id}
          method: delete
  
  getAccessUrl:
    handler: src/handlers/media.getAccessUrl
    events:
      - httpApi:
          path: /media/{id}/access-url
          method: get

  # Credits endpoints
  listCredits:
    handler: src/handlers/credits.listCredits
    events:
      - httpApi:
          path: /profiles/{id}/credits
          method: get
  
  createCredit:
    handler: src/handlers/credits.createCredit
    events:
      - httpApi:
          path: /profiles/{id}/credits
          method: post
  
  updateCredit:
    handler: src/handlers/credits.updateCredit
    events:
      - httpApi:
          path: /credits/{id}
          method: put
  
  deleteCredit:
    handler: src/handlers/credits.deleteCredit
    events:
      - httpApi:
          path: /credits/{id}
          method: delete

  # Settings endpoints
  getSettings:
    handler: src/handlers/settings.getSettings
    events:
      - httpApi:
          path: /settings
          method: get
  
  updateSettings:
    handler: src/handlers/settings.updateSettings
    events:
      - httpApi:
          path: /settings
          method: put
  
  exportAccountData:
    handler: src/handlers/settings.exportAccountData
    events:
      - httpApi:
          path: /account/export
          method: post
  
  deleteAccount:
    handler: src/handlers/settings.deleteAccount
    events:
      - httpApi:
          path: /account
          method: delete

  # Reel Request endpoints
  createReelRequest:
    handler: src/handlers/reelRequests.createReelRequest
    events:
      - httpApi:
          path: /reels/{id}/request
          method: post
  
  listReelRequests:
    handler: src/handlers/reelRequests.listReelRequests
    events:
      - httpApi:
          path: /reel-requests
          method: get
  
  approveReelRequest:
    handler: src/handlers/reelRequests.approveReelRequest
    events:
      - httpApi:
          path: /reel-requests/{id}/approve
          method: post
  
  denyReelRequest:
    handler: src/handlers/reelRequests.denyReelRequest
    events:
      - httpApi:
          path: /reel-requests/{id}/deny
          method: post

  # Search endpoints
  searchProfiles:
    handler: src/handlers/search.searchProfiles
    events:
      - httpApi:
          path: /search
          method: get
  
  searchUsers:
    handler: src/handlers/search.searchUsers
    events:
      - httpApi:
          path: /search/users
          method: get
