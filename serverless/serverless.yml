service: pv-api
frameworkVersion: "3"

plugins:
  - serverless-esbuild

provider:
  name: aws
  runtime: nodejs20.x
  region: ${env:AWS_REGION, "us-west-2"}
  stage: ${env:STAGE, "prod"}
  versionFunctions: false
  # Prisma layer is attached per-function only to DB-using handlers (see individual functions)
  # health and meta endpoints do NOT need Prisma layer
  httpApi:
    cors:
      allowedOrigins:
        - https://dkmxy676d3vgc.cloudfront.net
        - http://localhost:5173
        - http://localhost:3000
      allowedHeaders:
        - Content-Type
        - Authorization
        - X-CSRF-Token
        - X-Requested-With
        - Cookie
      allowedMethods:
        - GET
        - POST
        - PUT
        - PATCH
        - DELETE
        - OPTIONS
      allowCredentials: true
      maxAge: 86400  # Cache preflight requests for 24 hours
  environment:
    STAGE: ${env:STAGE, "prod"}
    # DATABASE_URL must be a valid PostgreSQL connection string with NO SPACES.
    # Format: postgresql://user:password@host:port/database?sslmode=require
    # Special characters in password must be URL-encoded (e.g., @ → %40, # → %23)
    DATABASE_URL: ${env:DATABASE_URL}
    MEDIA_BUCKET: ${env:MEDIA_BUCKET, "valine-media-uploads"}
    JWT_SECRET: ${env:JWT_SECRET}
    EMAIL_ENABLED: ${env:EMAIL_ENABLED, "false"}
    TWO_FACTOR_ENABLED: ${env:TWO_FACTOR_ENABLED, "false"}
    CSRF_ENABLED: ${env:CSRF_ENABLED, "false"}
    ENABLE_REGISTRATION: ${env:ENABLE_REGISTRATION, "true"}
    ALLOWED_USER_EMAILS: ${env:ALLOWED_USER_EMAILS, "ghawk075@gmail.com,valinejustin@gmail.com"}
    PR_INTEL_ENABLED: ${env:PR_INTEL_ENABLED, "false"}
    PR_INTEL_WEBHOOK_SECRET: ${env:PR_INTEL_WEBHOOK_SECRET, ""}
    FLAKY_DETECTOR_ENABLED: ${env:FLAKY_DETECTOR_ENABLED, "false"}
    SCHEMA_DIFF_ENABLED: ${env:SCHEMA_DIFF_ENABLED, "false"}
    SYNTHETIC_JOURNEY_ENABLED: ${env:SYNTHETIC_JOURNEY_ENABLED, "false"}
    SYNTHETIC_USE_REAL_REQUESTS: ${env:SYNTHETIC_USE_REAL_REQUESTS, "true"}
    OBSERVABILITY_ENABLED: ${env:OBSERVABILITY_ENABLED, "true"}
    API_BASE_URL: ${env:API_BASE_URL, "https://i72dxlcfcc.execute-api.us-west-2.amazonaws.com"}
    FRONTEND_URL: ${env:FRONTEND_URL, "https://dkmxy676d3vgc.cloudfront.net"}
    NODE_ENV: ${env:NODE_ENV, "production"}
    COOKIE_DOMAIN: ${env:COOKIE_DOMAIN, ".cloudfront.net"}
    REDIS_URL: ${env:REDIS_URL, ""}
    RATE_LIMITING_ENABLED: ${env:RATE_LIMITING_ENABLED, "true"}
    MODERATION_ENABLED: ${env:MODERATION_ENABLED, "false"}
    MODERATION_ALERTS_ENABLED: ${env:MODERATION_ALERTS_ENABLED, "false"}
    MODERATION_STRICT_MODE: ${env:MODERATION_STRICT_MODE, "false"}
    REPORTS_ENABLED: ${env:REPORTS_ENABLED, "true"}
    MODERATION_ALERT_CHANNEL_ID: ${env:MODERATION_ALERT_CHANNEL_ID, ""}
    ADMIN_ROLE_IDS: ${env:ADMIN_ROLE_IDS, ""}
    REPORTS_MAX_PER_HOUR: ${env:REPORTS_MAX_PER_HOUR, "5"}
    REPORTS_MAX_PER_DAY: ${env:REPORTS_MAX_PER_DAY, "20"}
    REPORTS_IP_MAX_PER_HOUR: ${env:REPORTS_IP_MAX_PER_HOUR, "10"}
    URL_ALLOWED_DOMAINS: ${env:URL_ALLOWED_DOMAINS, "imdb.com,youtube.com,vimeo.com,linkedin.com,github.com"}
    URL_BLOCKED_DOMAINS: ${env:URL_BLOCKED_DOMAINS, ""}
    URL_ALLOWED_PROTOCOLS: ${env:URL_ALLOWED_PROTOCOLS, "http:https:mailto:"}
    PROFANITY_LIST_PATH: ${env:PROFANITY_LIST_PATH, ""}
    PROFANITY_ACTION: ${env:PROFANITY_ACTION, "block"}
    REPORT_CATEGORY_ALLOWLIST: ${env:REPORT_CATEGORY_ALLOWLIST, "spam,abuse,unsafe_link,profanity,privacy,other"}
    ANALYTICS_ENABLED: ${env:ANALYTICS_ENABLED, "false"}
    ANALYTICS_REQUIRE_CONSENT: ${env:ANALYTICS_REQUIRE_CONSENT, "true"}
    ANALYTICS_STORAGE_DRIVER: ${env:ANALYTICS_STORAGE_DRIVER, "postgres"}
    ANALYTICS_RETENTION_DAYS: ${env:ANALYTICS_RETENTION_DAYS, "30"}
    ANALYTICS_ALLOWED_EVENTS: ${env:ANALYTICS_ALLOWED_EVENTS, "page_view,signup,login,profile_update,media_upload,logout"}
    ANALYTICS_SAMPLING_RATE: ${env:ANALYTICS_SAMPLING_RATE, "1.0"}
    ANALYTICS_CONSENT_COOKIE: ${env:ANALYTICS_CONSENT_COOKIE, "analytics_consent"}
    STRICT_ALLOWLIST: ${env:STRICT_ALLOWLIST, "0"}
    ADMIN_SEED_TOKEN: ${env:ADMIN_SEED_TOKEN, ""}

custom:
  esbuild:
    bundle: true
    minify: true
    sourcemap: false
    platform: node
    target: node20
    # Output CommonJS format for Lambda handler resolution
    format: cjs
    concurrency: 1
    external:
      - aws-sdk
      # Prisma must be external for Lambda - esbuild cannot bundle native binaries
      - '@prisma/client'
      - '.prisma/*'
      - '.prisma/client/*'
    # CRITICAL: 'exclude' prevents serverless-esbuild from packing these modules.
    # Without this, external modules are still npm-packed into each function bundle.
    # Prisma is provided via the Lambda Layer, so we exclude it from function bundles entirely.
    exclude:
      - '@prisma/client'
      - '.prisma/*'
      - '.prisma/client/*'
      - 'prisma'
    keepOutputDirectory: true
    # Prisma client generation handled externally before deploy
    packagerOptions:
      scripts: []

package:
  individually: true
  excludeDevDependencies: true
  patterns:
    - '!**/*.map'
    - '!**/tests/**'
    - '!**/__tests__/**'
    - '!**/*.md'
    - '!**/.git/**'
    - '!**/.vscode/**'
    - '!node_modules/.cache/**'
    # IMPORTANT: Prisma is provided via the PrismaLambdaLayer, NOT bundled per-function.
    # Exclude all Prisma files from function packages to keep them small.
    - '!node_modules/@prisma/**'
    - '!node_modules/.prisma/**'
    - '!node_modules/prisma/**'

# =========================================================================
# Prisma Lambda Layer
# =========================================================================
# The Prisma client and native binaries are large (~93MB compressed).
# Including them in each function zip would exceed Lambda's 250MB limit.
# Instead, we use a Lambda Layer that is built separately and attached
# to all functions via provider.layers above.
#
# To build the layer before deployment:
#   Windows:   .\scripts\build-prisma-layer.ps1
#   Linux/Mac: ./scripts/build-prisma-layer.sh
#
# The layer contains:
#   - nodejs/node_modules/@prisma/client (Prisma client runtime)
#   - nodejs/node_modules/.prisma/client (generated client + native binary)
#
# See layers/README.md for more details.
# =========================================================================
layers:
  prisma:
    name: ${self:service}-${self:provider.stage}-prisma
    description: Prisma client and native binaries for Lambda (Node.js 20.x)
    compatibleRuntimes:
      - nodejs20.x
    package:
      artifact: layers/prisma-layer.zip

functions:
  health:
    handler: src/handlers/health.handler
    events:
      - httpApi:
          path: /health
          method: get
  meta:
    handler: src/handlers/meta.handler
    events:
      - httpApi:
          path: /meta
          method: get
  
  # ========== AUTH ==========
  register:
    handler: src/handlers/auth.register
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /auth/register
          method: post
  login:
    handler: src/handlers/auth.login
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /auth/login
          method: post
  me:
    handler: src/handlers/auth.me
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /auth/me
          method: get
  verifyEmail:
    handler: src/handlers/auth.verifyEmail
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /auth/verify-email
          method: post
  resendVerification:
    handler: src/handlers/auth.resendVerification
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /auth/resend-verification
          method: post
  refresh:
    handler: src/handlers/auth.refresh
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /auth/refresh
          method: post
  logout:
    handler: src/handlers/auth.logout
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /auth/logout
          method: post
  setup2FA:
    handler: src/handlers/auth.setup2FA
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /auth/2fa/setup
          method: post
  enable2FA:
    handler: src/handlers/auth.enable2FA
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /auth/2fa/enable
          method: post
  verify2FA:
    handler: src/handlers/auth.verify2FA
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /auth/2fa/verify
          method: post
  disable2FA:
    handler: src/handlers/auth.disable2FA
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /auth/2fa/disable
          method: post
  seedRestricted:
    handler: src/handlers/auth.seedRestricted
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /auth/seed-restricted
          method: post
  authStatus:
    handler: src/handlers/auth.authStatus
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /auth/status
          method: get
  authDiag:
  handler: src/handlers/auth.authDiag
  layers: []     # explicitly none if no DB access
  events:
    - httpApi:
        path: /auth/diag
        method: get

  # ========== USERS ==========
  createUser:
    handler: src/handlers/users.createUser
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /users
          method: post
  getUser:
    handler: src/handlers/users.getUser
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /users/{username}
          method: get
  updateUser:
    handler: src/handlers/users.updateUser
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /users/{id}
          method: put

  # ========== REELS ==========
  listReels:
    handler: src/handlers/reels.listReels
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /reels
          method: get
  createReel:
    handler: src/handlers/reels.createReel
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /reels
          method: post
  toggleLike:
    handler: src/handlers/reels.toggleLike
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /reels/{id}/like
          method: post
  toggleBookmark:
    handler: src/handlers/reels.toggleBookmark
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /reels/{id}/bookmark
          method: post
  getReelComments:
    handler: src/handlers/reels.getComments
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /reels/{id}/comments
          method: get
  createReelComment:
    handler: src/handlers/reels.createComment
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /reels/{id}/comments
          method: post

  # ========== POSTS ==========
  createPost:
    handler: src/handlers/posts.createPost
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /posts
          method: post
  listPosts:
    handler: src/handlers/posts.listPosts
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /posts
          method: get
  getPost:
    handler: src/handlers/posts.getPost
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /posts/{id}
          method: get
  getAudioUploadUrl:
    handler: src/handlers/posts.getAudioUploadUrl
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /posts/audio-upload-url
          method: post
  requestPostAccess:
    handler: src/handlers/posts.requestPostAccess
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /posts/{id}/request
          method: post

  # ========== SCRIPTS ==========
  listScripts:
    handler: src/handlers/scripts.listScripts
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /scripts
          method: get
  createScript:
    handler: src/handlers/scripts.createScript
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /scripts
          method: post
  getScript:
    handler: src/handlers/scripts.getScript
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /scripts/{id}
          method: get

  # ========== AUDITIONS ==========
  listAuditions:
    handler: src/handlers/auditions.listAuditions
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /auditions
          method: get
  createAudition:
    handler: src/handlers/auditions.createAudition
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /auditions
          method: post
  getAudition:
    handler: src/handlers/auditions.getAudition
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /auditions/{id}
          method: get

  # ========== FEED ==========
  getFeed:
    handler: src/handlers/feed.getFeed
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /feed
          method: get

  # ========== CONVERSATIONS ==========
  listConversations:
    handler: src/handlers/conversations.listConversations
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /conversations
          method: get
  createConversation:
    handler: src/handlers/conversations.createConversation
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /conversations
          method: post
  getMessages:
    handler: src/handlers/conversations.getMessages
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /conversations/{id}/messages
          method: get
  sendMessage:
    handler: src/handlers/conversations.sendMessage
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /conversations/{id}/messages
          method: post

  # ========== NOTIFICATIONS ==========
  listNotifications:
    handler: src/handlers/notifications.listNotifications
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /notifications
          method: get
  markNotificationRead:
    handler: src/handlers/notifications.markAsRead
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /notifications/{id}/read
          method: patch
  markAllNotificationsRead:
    handler: src/handlers/notifications.markAllAsRead
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /notifications/mark-all
          method: patch
  
  # ========== NEW: UNREAD COUNTS ==========
  getUnreadCounts:
    handler: src/handlers/notifications.getUnreadCounts
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /unread-counts
          method: get

  # ========== CONNECTIONS ==========
  sendConnectionRequest:
    handler: src/handlers/connections.sendRequest
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /connections/request
          method: post
  listConnectionRequests:
    handler: src/handlers/connections.listRequests
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /connections/requests
          method: get
  approveConnectionRequest:
    handler: src/handlers/connections.approveRequest
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /connections/requests/{id}/approve
          method: post
  rejectConnectionRequest:
    handler: src/handlers/connections.rejectRequest
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /connections/requests/{id}/reject
          method: post
  followUser:
    handler: src/handlers/connections.followUser
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /connections/follow
          method: post
  getConnectionStatus:
    handler: src/handlers/connections.getConnectionStatus
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /connections/status/{userId}
          method: get
  unfollowUser:
    handler: src/handlers/connections.unfollowUser
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /connections/unfollow
          method: post

  # ========== PROFILES ==========
  getProfileByVanity:
    handler: src/handlers/profiles.getProfileByVanity
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /profiles/{vanityUrl}
          method: get
  getProfileById:
    handler: src/handlers/profiles.getProfileById
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /profiles/id/{id}
          method: get
  createProfile:
    handler: src/handlers/profiles.createProfile
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /profiles
          method: post
  updateProfile:
    handler: src/handlers/profiles.updateProfile
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /profiles/id/{id}
          method: put
  updateMyProfile:
    handler: src/handlers/profiles.updateMyProfile
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /me/profile
          method: patch
  getMyProfile:
    handler: src/handlers/profiles.getMyProfile
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /me/profile
          method: get
  deleteProfile:
    handler: src/handlers/profiles.deleteProfile
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /profiles/id/{id}
          method: delete

  # ========== MEDIA ==========
  getUploadUrl:
    handler: src/handlers/media.getUploadUrl
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /profiles/{id}/media/upload-url
          method: post
  completeUpload:
    handler: src/handlers/media.completeUpload
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /profiles/{id}/media/complete
          method: post
  updateMedia:
    handler: src/handlers/media.updateMedia
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /media/{id}
          method: put
  deleteMedia:
    handler: src/handlers/media.deleteMedia
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /media/{id}
          method: delete
  getAccessUrl:
    handler: src/handlers/media.getAccessUrl
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /media/{id}/access-url
          method: get

  # ========== CREDITS ==========
  listCredits:
    handler: src/handlers/credits.listCredits
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /profiles/{id}/credits
          method: get
  createCredit:
    handler: src/handlers/credits.createCredit
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /profiles/{id}/credits
          method: post
  updateCredit:
    handler: src/handlers/credits.updateCredit
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /credits/{id}
          method: put
  deleteCredit:
    handler: src/handlers/credits.deleteCredit
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /credits/{id}
          method: delete

  # ========== EDUCATION ==========
# Education handlers with NO layer (explicitly clear layers)
listEducation:
  handler: src/handlers/education.listEducation
  layers: []     # explicitly none
  events:
    - httpApi:
        path: /me/profile/education
        method: get

createEducation:
  handler: src/handlers/education.createEducation
  layers: []     # explicitly none
  events:
    - httpApi:
        path: /me/profile/education
        method: post

updateEducation:
  handler: src/handlers/education.updateEducation
  layers: []     # explicitly none
  events:
    - httpApi:
        path: /me/profile/education/{id}
        method: put

deleteEducation:
  handler: src/handlers/education.deleteEducation
  layers: []     # explicitly none
  events:
    - httpApi:
        path: /me/profile/education/{id}
        method: delete

  # ========== SETTINGS ==========
  getSettings:
    handler: src/handlers/settings.getSettings
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /settings
          method: get
  updateSettings:
    handler: src/handlers/settings.updateSettings
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /settings
          method: put
  exportAccountData:
    handler: src/handlers/settings.exportAccountData
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /account/export
          method: post
  deleteAccount:
    handler: src/handlers/settings.deleteAccount
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /account
          method: delete
  getPreferences:
    handler: src/handlers/settings.getPreferences
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /me/preferences
          method: get
  updatePreferences:
    handler: src/handlers/settings.updatePreferences
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /me/preferences
          method: put
  patchPreferences:
    handler: src/handlers/settings.updatePreferences
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /me/preferences
          method: patch

  # ========== REEL REQUESTS ==========
  createReelRequest:
    handler: src/handlers/reelRequests.createReelRequest
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /reels/{id}/request
          method: post
  listReelRequests:
    handler: src/handlers/reelRequests.listReelRequests
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /reel-requests
          method: get
  approveReelRequest:
    handler: src/handlers/reelRequests.approveReelRequest
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /reel-requests/{id}/approve
          method: post
  denyReelRequest:
    handler: src/handlers/reelRequests.denyReelRequest
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /reel-requests/{id}/deny
          method: post

  # ========== SEARCH ==========
  searchProfiles:
    handler: src/handlers/search.searchProfiles
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /search
          method: get
  searchUsers:
    handler: src/handlers/search.searchUsers
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /search/users
          method: get

  # ========== REPORTS & MODERATION ==========
  createReport:
    handler: src/handlers/reports.createReport
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /reports
          method: post
  listReports:
    handler: src/handlers/reports.listReports
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /reports
          method: get
  getReport:
    handler: src/handlers/reports.getReport
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /reports/{id}
          method: get
  makeDecision:
    handler: src/handlers/moderation.makeDecision
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /moderation/decision
          method: post
  moderationHealth:
    handler: src/handlers/moderation.getHealth
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /moderation/health
          method: get

  # ========== ANALYTICS ==========
  analyticsIngest:
    handler: src/handlers/analytics.ingestEvents
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /analytics/ingest
          method: post
  analyticsConfig:
    handler: src/handlers/analytics.getConfig
    layers:
      - { Ref: PrismaLambdaLayer }
    events:
      - httpApi:
          path: /analytics/config
          method: get