service: pv-api
frameworkVersion: "3"

plugins:
  - serverless-esbuild

provider:
  name: aws
  runtime: nodejs20.x
  region: ${env:AWS_REGION, "us-west-2"}
  stage: ${env:STAGE, "prod"}
  versionFunctions: false
  # Prisma layer is attached per-function only to DB-using handlers (see individual functions)
  # health and meta endpoints do NOT need Prisma layer
  httpApi:
    cors:
      allowedOrigins:
        - https://dkmxy676d3vgc.cloudfront.net
        - http://localhost:5173
        - http://localhost:3000
      allowedHeaders:
        - Content-Type
        - Authorization
        - X-CSRF-Token
        - X-Requested-With
        - Cookie
      allowedMethods:
        - GET
        - POST
        - PUT
        - PATCH
        - DELETE
        - OPTIONS
      allowCredentials: true
      maxAge: 86400  # Cache preflight requests for 24 hours
  environment:
    STAGE: ${env:STAGE, "prod"}
    
    # ========== CRITICAL ENVIRONMENT VARIABLES ==========
    # These variables are REQUIRED and validated at runtime.
    # Missing or invalid values will cause Lambda functions to fail-fast.
    # DO NOT deploy without setting these correctly!
    
    # DATABASE_URL - REQUIRED
    # Must be a valid PostgreSQL connection string with NO SPACES.
    # Format: postgresql://user:password@host:port/database?sslmode=require
    # Special characters in password must be URL-encoded (e.g., @ → %40, # → %23)
    # Runtime validation: checks for existence, spaces, and postgresql:// prefix
    DATABASE_URL: ${env:DATABASE_URL}
    
    # JWT_SECRET - REQUIRED
    # Must be at least 32 characters long.
    # MUST NOT use default value in production.
    # Generate with: node -e "console.log(require('crypto').randomBytes(64).toString('hex'))"
    # Runtime validation: checks length, rejects default value in production
    JWT_SECRET: ${env:JWT_SECRET}
    
    # NODE_ENV - REQUIRED
    # Must be one of: development, test, production
    # Controls cookie SameSite attribute (Lax in dev, None in prod)
    # Runtime validation: checks for valid values
    NODE_ENV: ${env:NODE_ENV, "production"}
    
    # ========== IMPORTANT ENVIRONMENT VARIABLES ==========
    # These should be set but have defaults or graceful degradation
    
    MEDIA_BUCKET: ${env:MEDIA_BUCKET, "valine-media-uploads"}
    FRONTEND_URL: ${env:FRONTEND_URL, "https://dkmxy676d3vgc.cloudfront.net"}
    API_BASE_URL: ${env:API_BASE_URL, "https://i72dxlcfcc.execute-api.us-west-2.amazonaws.com"}
    
    # ========== OPTIONAL ENVIRONMENT VARIABLES ==========
    # These have defaults and are not validated at startup
    
    EMAIL_ENABLED: ${env:EMAIL_ENABLED, "false"}
    TWO_FACTOR_ENABLED: ${env:TWO_FACTOR_ENABLED, "false"}
    CSRF_ENABLED: ${env:CSRF_ENABLED, "false"}
    ENABLE_REGISTRATION: ${env:ENABLE_REGISTRATION, "true"}
    ALLOWED_USER_EMAILS: ${env:ALLOWED_USER_EMAILS, "ghawk075@gmail.com,valinejustin@gmail.com"}
    PR_INTEL_ENABLED: ${env:PR_INTEL_ENABLED, "false"}
    PR_INTEL_WEBHOOK_SECRET: ${env:PR_INTEL_WEBHOOK_SECRET, ""}
    FLAKY_DETECTOR_ENABLED: ${env:FLAKY_DETECTOR_ENABLED, "false"}
    SCHEMA_DIFF_ENABLED: ${env:SCHEMA_DIFF_ENABLED, "false"}
    SYNTHETIC_JOURNEY_ENABLED: ${env:SYNTHETIC_JOURNEY_ENABLED, "false"}
    SYNTHETIC_USE_REAL_REQUESTS: ${env:SYNTHETIC_USE_REAL_REQUESTS, "true"}
    OBSERVABILITY_ENABLED: ${env:OBSERVABILITY_ENABLED, "true"}
    API_BASE_URL: ${env:API_BASE_URL, "https://i72dxlcfcc.execute-api.us-west-2.amazonaws.com"}
    FRONTEND_URL: ${env:FRONTEND_URL, "https://dkmxy676d3vgc.cloudfront.net"}
    NODE_ENV: ${env:NODE_ENV, "production"}
    COOKIE_DOMAIN: ${env:COOKIE_DOMAIN, ".cloudfront.net"}
    REDIS_URL: ${env:REDIS_URL, ""}
    RATE_LIMITING_ENABLED: ${env:RATE_LIMITING_ENABLED, "true"}
    MODERATION_ENABLED: ${env:MODERATION_ENABLED, "false"}
    MODERATION_ALERTS_ENABLED: ${env:MODERATION_ALERTS_ENABLED, "false"}
    MODERATION_STRICT_MODE: ${env:MODERATION_STRICT_MODE, "false"}
    REPORTS_ENABLED: ${env:REPORTS_ENABLED, "true"}
    MODERATION_ALERT_CHANNEL_ID: ${env:MODERATION_ALERT_CHANNEL_ID, ""}
    ADMIN_ROLE_IDS: ${env:ADMIN_ROLE_IDS, ""}
    REPORTS_MAX_PER_HOUR: ${env:REPORTS_MAX_PER_HOUR, "5"}
    REPORTS_MAX_PER_DAY: ${env:REPORTS_MAX_PER_DAY, "20"}
    REPORTS_IP_MAX_PER_HOUR: ${env:REPORTS_IP_MAX_PER_HOUR, "10"}
    URL_ALLOWED_DOMAINS: ${env:URL_ALLOWED_DOMAINS, "imdb.com,youtube.com,vimeo.com,linkedin.com,github.com"}
    URL_BLOCKED_DOMAINS: ${env:URL_BLOCKED_DOMAINS, ""}
    URL_ALLOWED_PROTOCOLS: ${env:URL_ALLOWED_PROTOCOLS, "http:https:mailto:"}
    PROFANITY_LIST_PATH: ${env:PROFANITY_LIST_PATH, ""}
    PROFANITY_ACTION: ${env:PROFANITY_ACTION, "block"}
    REPORT_CATEGORY_ALLOWLIST: ${env:REPORT_CATEGORY_ALLOWLIST, "spam,abuse,unsafe_link,profanity,privacy,other"}
    ANALYTICS_ENABLED: ${env:ANALYTICS_ENABLED, "false"}
    ANALYTICS_REQUIRE_CONSENT: ${env:ANALYTICS_REQUIRE_CONSENT, "true"}
    ANALYTICS_STORAGE_DRIVER: ${env:ANALYTICS_STORAGE_DRIVER, "postgres"}
    ANALYTICS_RETENTION_DAYS: ${env:ANALYTICS_RETENTION_DAYS, "30"}
    ANALYTICS_ALLOWED_EVENTS: ${env:ANALYTICS_ALLOWED_EVENTS, "page_view,signup,login,profile_update,media_upload,logout"}
    ANALYTICS_SAMPLING_RATE: ${env:ANALYTICS_SAMPLING_RATE, "1.0"}
    ANALYTICS_CONSENT_COOKIE: ${env:ANALYTICS_CONSENT_COOKIE, "analytics_consent"}
    STRICT_ALLOWLIST: ${env:STRICT_ALLOWLIST, "0"}
    ADMIN_SEED_TOKEN: ${env:ADMIN_SEED_TOKEN, ""}

custom:
  esbuild:
    bundle: true
    minify: true
    sourcemap: false
    platform: node
    target: node20
    # Output CommonJS format for Lambda handler resolution
    format: cjs
    concurrency: 1
    external:
      - aws-sdk
      # Prisma must be external for Lambda - esbuild cannot bundle native binaries
      - '@prisma/client'
      - '.prisma/*'
      - '.prisma/client/*'
    # CRITICAL: 'exclude' prevents serverless-esbuild from packing these modules.
    # Without this, external modules are still npm-packed into each function bundle.
    # Prisma is provided via the Lambda Layer, so we exclude it from function bundles entirely.
    exclude:
      - '@prisma/client'
      - '.prisma/*'
      - '.prisma/client/*'
      - 'prisma'
    keepOutputDirectory: false
    # Prisma client generation handled externally before deploy
    # noDependencies: true prevents ALL node_modules (especially devDependencies like @prisma/client)
    # from being bundled into function packages. Prisma is provided via Lambda Layer instead.
    packagerOptions:
      scripts: []
      noDependencies: true

package:
  individually: true
  excludeDevDependencies: true
  patterns:
    - '!**' # Exclude ALL files from the project root. Only esbuild output should remain.

# =========================================================================
# Prisma Lambda Layer
# =========================================================================
# The Prisma client and native binaries are large (~93MB compressed).
# Including them in each function zip would exceed Lambda's 250MB limit.
# Instead, we use a Lambda Layer that is built separately and attached
# to all functions via provider.layers above.
#
# To build the layer before deployment:
#   Windows:   .\scripts\build-prisma-layer.ps1
#   Linux/Mac: ./scripts/build-prisma-layer.sh
#
# The layer contains:
#   - nodejs/node_modules/@prisma/client (Prisma client runtime)
#   - nodejs/node_modules/.prisma/client (generated client + native binary)
#
# See layers/README.md for more details.
# =========================================================================
layers:
  prismaV2:
    name: ${self:service}-${self:provider.stage}-prisma-v2
    description: Prisma client and native binaries for Lambda (Node.js 20.x)
    compatibleRuntimes:
      - nodejs20.x
    package:
      artifact: layers/prisma-layer.zip

functions:
  health:
    handler: src/handlers/health.handler
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /health
          method: get
  meta:
    handler: src/handlers/meta.handler
    layers: []     # explicitly none - no DB access
    events:
      - httpApi:
          path: /meta
          method: get
  
  # ========== AUTH ROUTER ==========
  authRouter:
    handler: src/handlers/authRouter.handler
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /auth/register
          method: post
      - httpApi:
          path: /auth/login
          method: post
      - httpApi:
          path: /auth/me
          method: get
      - httpApi:
          path: /auth/verify-email
          method: post
      - httpApi:
          path: /auth/resend-verification
          method: post
      - httpApi:
          path: /auth/refresh
          method: post
      - httpApi:
          path: /auth/logout
          method: post
      - httpApi:
          path: /auth/2fa/setup
          method: post
      - httpApi:
          path: /auth/2fa/enable
          method: post
      - httpApi:
          path: /auth/2fa/verify
          method: post
      - httpApi:
          path: /auth/2fa/disable
          method: post
      - httpApi:
          path: /auth/seed-restricted
          method: post
      - httpApi:
          path: /auth/status
          method: get
      - httpApi:
          path: /auth/diag
          method: get

  # ========== USERS ==========
  createUser:
    handler: src/handlers/users.createUser
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /users
          method: post
  getUser:
    handler: src/handlers/users.getUser
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /users/{username}
          method: get
  updateUser:
    handler: src/handlers/users.updateUser
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /users/{id}
          method: put

  # ========== REELS ==========
  listReels:
    handler: src/handlers/reels.listReels
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /reels
          method: get
  createReel:
    handler: src/handlers/reels.createReel
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /reels
          method: post
  toggleLike:
    handler: src/handlers/reels.toggleLike
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /reels/{id}/like
          method: post
  toggleBookmark:
    handler: src/handlers/reels.toggleBookmark
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /reels/{id}/bookmark
          method: post
  getReelComments:
    handler: src/handlers/reels.getComments
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /reels/{id}/comments
          method: get
  createReelComment:
    handler: src/handlers/reels.createComment
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /reels/{id}/comments
          method: post

  # ========== POSTS ROUTER ==========
  postsRouter:
    handler: src/handlers/postsRouter.handler
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /posts
          method: get
      - httpApi:
          path: /posts
          method: post
      - httpApi:
          path: /posts/audio-upload-url
          method: post
      - httpApi:
          path: /posts/{id}
          method: get
      - httpApi:
          path: /posts/{id}
          method: delete
      - httpApi:
          path: /posts/{id}/request
          method: post

  # ========== SCRIPTS ==========
  listScripts:
    handler: src/handlers/scripts.listScripts
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /scripts
          method: get
  createScript:
    handler: src/handlers/scripts.createScript
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /scripts
          method: post
  getScript:
    handler: src/handlers/scripts.getScript
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /scripts/{id}
          method: get

  # ========== AUDITIONS ==========
  listAuditions:
    handler: src/handlers/auditions.listAuditions
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /auditions
          method: get
  createAudition:
    handler: src/handlers/auditions.createAudition
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /auditions
          method: post
  getAudition:
    handler: src/handlers/auditions.getAudition
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /auditions/{id}
          method: get

  # ========== FEED ==========
  getFeed:
    handler: src/handlers/feed.getFeed
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /feed
          method: get

  # ========== CONVERSATIONS ==========
  listConversations:
    handler: src/handlers/conversations.listConversations
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /conversations
          method: get
  createConversation:
    handler: src/handlers/conversations.createConversation
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /conversations
          method: post
  getMessages:
    handler: src/handlers/conversations.getMessages
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /conversations/{id}/messages
          method: get
  sendMessage:
    handler: src/handlers/conversations.sendMessage
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /conversations/{id}/messages
          method: post

  # ========== SOCIAL + MESSAGING ROUTER ==========
  socialMessaging:
    handler: src/handlers/socialMessaging.handler
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      # --- Social graph ---
      - httpApi:
          path: /profiles/{profileId}/follow
          method: post
      - httpApi:
          path: /profiles/{profileId}/follow
          method: delete
      - httpApi:
          path: /profiles/{profileId}/block
          method: post
      - httpApi:
          path: /profiles/{profileId}/block
          method: delete
      - httpApi:
          path: /profiles/{profileId}/followers
          method: get
      - httpApi:
          path: /profiles/{profileId}/following
          method: get
      - httpApi:
          path: /profiles/{profileId}/status
          method: get
      - httpApi:
          path: /me/followers
          method: get
      - httpApi:
          path: /me/following
          method: get
      - httpApi:
          path: /me/blocks
          method: get
      # --- DM threads ---
      - httpApi:
          path: /me/messages/threads
          method: get
      - httpApi:
          path: /me/messages/threads
          method: post
      - httpApi:
          path: /me/messages/threads/{threadId}
          method: get
      - httpApi:
          path: /me/messages/threads/{threadId}/messages
          method: post

  # ========== NOTIFICATIONS ROUTER ==========
  notificationsRouter:
    handler: src/handlers/notificationsRouter.handler
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /notifications
          method: get
      - httpApi:
          path: /notifications/{id}/read
          method: patch
      - httpApi:
          path: /notifications/mark-all
          method: patch
      - httpApi:
          path: /unread-counts
          method: get

  # ========== CONNECTIONS ==========
  sendConnectionRequest:
    handler: src/handlers/connections.sendRequest
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /connections/request
          method: post
  listConnectionRequests:
    handler: src/handlers/connections.listRequests
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /connections/requests
          method: get
  approveConnectionRequest:
    handler: src/handlers/connections.approveRequest
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /connections/requests/{id}/approve
          method: post
  rejectConnectionRequest:
    handler: src/handlers/connections.rejectRequest
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /connections/requests/{id}/reject
          method: post
  followUser:
    handler: src/handlers/connections.followUser
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /connections/follow
          method: post
  getConnectionStatus:
    handler: src/handlers/connections.getConnectionStatus
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /connections/status/{userId}
          method: get
  unfollowUser:
    handler: src/handlers/connections.unfollowUser
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /connections/unfollow
          method: post

  # ========== PROFILES ROUTER ==========
  profilesRouter:
    handler: src/handlers/profilesRouter.handler
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      # Profile endpoints
      - httpApi:
          path: /profiles/{vanityUrl}
          method: get
      - httpApi:
          path: /profiles/id/{id}
          method: get
      - httpApi:
          path: /profiles
          method: post
      - httpApi:
          path: /profiles/id/{id}
          method: put
      - httpApi:
          path: /profiles/id/{id}
          method: delete
      - httpApi:
          path: /me/profile
          method: get
      - httpApi:
          path: /me/profile
          method: patch
      # Education endpoints
      - httpApi:
          path: /me/profile/education
          method: get
      - httpApi:
          path: /me/profile/education
          method: post
      - httpApi:
          path: /me/profile/education/{id}
          method: put
      - httpApi:
          path: /me/profile/education/{id}
          method: delete
      # Experience endpoints
      - httpApi:
          path: /me/profile/experience
          method: get
      - httpApi:
          path: /me/profile/experience
          method: post
      - httpApi:
          path: /me/profile/experience/{id}
          method: put
      - httpApi:
          path: /me/profile/experience/{id}
          method: delete

  # ========== MEDIA ==========
  getUploadUrl:
    handler: src/handlers/media.getUploadUrl
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /profiles/{id}/media/upload-url
          method: post
  completeUpload:
    handler: src/handlers/media.completeUpload
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /profiles/{id}/media/complete
          method: post
  updateMedia:
    handler: src/handlers/media.updateMedia
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /media/{id}
          method: put
  deleteMedia:
    handler: src/handlers/media.deleteMedia
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /media/{id}
          method: delete
  getAccessUrl:
    handler: src/handlers/media.getAccessUrl
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /media/{id}/access-url
          method: get

  # ========== CREDITS ==========
  listCredits:
    handler: src/handlers/credits.listCredits
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /profiles/{id}/credits
          method: get
  createCredit:
    handler: src/handlers/credits.createCredit
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /profiles/{id}/credits
          method: post
  updateCredit:
    handler: src/handlers/credits.updateCredit
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /credits/{id}
          method: put
  deleteCredit:
    handler: src/handlers/credits.deleteCredit
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /credits/{id}
          method: delete

  # ========== SETTINGS ==========
  getSettings:
    handler: src/handlers/settings.getSettings
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /settings
          method: get
  updateSettings:
    handler: src/handlers/settings.updateSettings
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /settings
          method: put
  exportAccountData:
    handler: src/handlers/settings.exportAccountData
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /account/export
          method: post
  deleteAccount:
    handler: src/handlers/settings.deleteAccount
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /account
          method: delete
  getPreferences:
    handler: src/handlers/settings.getPreferences
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /me/preferences
          method: get
  updatePreferences:
    handler: src/handlers/settings.updatePreferences
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /me/preferences
          method: put
  patchPreferences:
    handler: src/handlers/settings.updatePreferences
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /me/preferences
          method: patch

  # ========== REEL REQUESTS ==========
  createReelRequest:
    handler: src/handlers/reelRequests.createReelRequest
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /reels/{id}/request
          method: post
  listReelRequests:
    handler: src/handlers/reelRequests.listReelRequests
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /reel-requests
          method: get
  approveReelRequest:
    handler: src/handlers/reelRequests.approveReelRequest
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /reel-requests/{id}/approve
          method: post
  denyReelRequest:
    handler: src/handlers/reelRequests.denyReelRequest
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /reel-requests/{id}/deny
          method: post

  # ========== SEARCH ==========
  searchProfiles:
    handler: src/handlers/search.searchProfiles
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /search
          method: get
  searchUsers:
    handler: src/handlers/search.searchUsers
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /search/users
          method: get

  # ========== REPORTS & MODERATION ==========
  createReport:
    handler: src/handlers/reports.createReport
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /reports
          method: post
  listReports:
    handler: src/handlers/reports.listReports
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /reports
          method: get
  getReport:
    handler: src/handlers/reports.getReport
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /reports/{id}
          method: get
  makeDecision:
    handler: src/handlers/moderation.makeDecision
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /moderation/decision
          method: post
  moderationHealth:
    handler: src/handlers/moderation.getHealth
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /moderation/health
          method: get

  # ========== ANALYTICS ==========
  analyticsIngest:
    handler: src/handlers/analytics.ingestEvents
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /analytics/ingest
          method: post
  analyticsConfig:
    handler: src/handlers/analytics.getConfig
    layers:
      - { Ref: PrismaV2LambdaLayer }
    events:
      - httpApi:
          path: /analytics/config
          method: get
