service: pv-api
frameworkVersion: "3"

provider:
  name: aws
  runtime: nodejs20.x
  region: ${env:AWS_REGION, "us-west-2"}
  stage: ${env:STAGE, "prod"}
  httpApi:
    cors: true
  environment:
    STAGE: ${env:STAGE, "prod"}
    DATABASE_URL: ${env:DATABASE_URL}

package:
  patterns:
    - '!.git/**'
    - '!.github/**'
    - '!*.md'
    - '!test/**'
    - '!tests/**'

functions:
  # Health & Meta endpoints
  health:
    handler: src/handlers/health.handler
    events:
      - httpApi:
          path: /health
          method: get
  
  meta:
    handler: src/handlers/meta.handler
    events:
      - httpApi:
          path: /meta
          method: get

  # Authentication endpoints
  register:
    handler: src/handlers/auth.register
    events:
      - httpApi:
          path: /auth/register
          method: post
  
  login:
    handler: src/handlers/auth.login
    events:
      - httpApi:
          path: /auth/login
          method: post
  
  me:
    handler: src/handlers/auth.me
    events:
      - httpApi:
          path: /auth/me
          method: get

  # User endpoints
  createUser:
    handler: src/handlers/users.createUser
    events:
      - httpApi:
          path: /users
          method: post
  
  getUser:
    handler: src/handlers/users.getUser
    events:
      - httpApi:
          path: /users/{username}
          method: get
  
  updateUser:
    handler: src/handlers/users.updateUser
    events:
      - httpApi:
          path: /users/{id}
          method: put
  
  # Reels endpoints
  listReels:
    handler: src/handlers/reels.listReels
    events:
      - httpApi:
          path: /reels
          method: get
  
  createReel:
    handler: src/handlers/reels.createReel
    events:
      - httpApi:
          path: /reels
          method: post
  
  toggleLike:
    handler: src/handlers/reels.toggleLike
    events:
      - httpApi:
          path: /reels/{id}/like
          method: post
  
  toggleBookmark:
    handler: src/handlers/reels.toggleBookmark
    events:
      - httpApi:
          path: /reels/{id}/bookmark
          method: post
  
  getReelComments:
    handler: src/handlers/reels.getComments
    events:
      - httpApi:
          path: /reels/{id}/comments
          method: get
  
  createReelComment:
    handler: src/handlers/reels.createComment
    events:
      - httpApi:
          path: /reels/{id}/comments
          method: post
  
  # Post endpoints (legacy)
  createPost:
    handler: src/handlers/posts.createPost
    events:
      - httpApi:
          path: /posts
          method: post
  
  listPosts:
    handler: src/handlers/posts.listPosts
    events:
      - httpApi:
          path: /posts
          method: get
  
  getPost:
    handler: src/handlers/posts.getPost
    events:
      - httpApi:
          path: /posts/{id}
          method: get
  
  # Conversation endpoints
  listConversations:
    handler: src/handlers/conversations.listConversations
    events:
      - httpApi:
          path: /conversations
          method: get
  
  createConversation:
    handler: src/handlers/conversations.createConversation
    events:
      - httpApi:
          path: /conversations
          method: post
  
  getMessages:
    handler: src/handlers/conversations.getMessages
    events:
      - httpApi:
          path: /conversations/{id}/messages
          method: get
  
  sendMessage:
    handler: src/handlers/conversations.sendMessage
    events:
      - httpApi:
          path: /conversations/{id}/messages
          method: post
  
  # Notification endpoints
  listNotifications:
    handler: src/handlers/notifications.listNotifications
    events:
      - httpApi:
          path: /notifications
          method: get
  
  markNotificationRead:
    handler: src/handlers/notifications.markAsRead
    events:
      - httpApi:
          path: /notifications/{id}/read
          method: patch
  
  markAllNotificationsRead:
    handler: src/handlers/notifications.markAllAsRead
    events:
      - httpApi:
          path: /notifications/mark-all
          method: patch
  
  # Connection endpoints
  sendConnectionRequest:
    handler: src/handlers/connections.sendRequest
    events:
      - httpApi:
          path: /connections/request
          method: post
  
  listConnectionRequests:
    handler: src/handlers/connections.listRequests
    events:
      - httpApi:
          path: /connections/requests
          method: get
  
  approveConnectionRequest:
    handler: src/handlers/connections.approveRequest
    events:
      - httpApi:
          path: /connections/requests/{id}/approve
          method: post
  
  rejectConnectionRequest:
    handler: src/handlers/connections.rejectRequest
    events:
      - httpApi:
          path: /connections/requests/{id}/reject
          method: post
