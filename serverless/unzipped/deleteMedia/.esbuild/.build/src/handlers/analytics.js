var x=Object.create;var l=Object.defineProperty;var P=Object.getOwnPropertyDescriptor;var L=Object.getOwnPropertyNames;var D=Object.getPrototypeOf,I=Object.prototype.hasOwnProperty;var T=(t,e)=>()=>(t&&(e=t(t=0)),e);var R=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports),k=(t,e)=>{for(var r in e)l(t,r,{get:e[r],enumerable:!0})},w=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of L(e))!I.call(t,s)&&s!==r&&l(t,s,{get:()=>e[s],enumerable:!(n=P(e,s))||n.enumerable});return t};var j=(t,e,r)=>(r=t!=null?x(D(t)):{},w(e||!t||!t.__esModule?l(r,"default",{value:t,enumerable:!0}):r,t)),m=t=>w(l({},"__esModule",{value:!0}),t);var Q={};function W(t){return typeof t=="function"?t:e=>e.$extends(t)}function $(t){return t}var u,J,M,z,Y,B,V,v,q,F,U,K,C,G,g=T(()=>{"use strict";u=Object.defineProperty,J=Object.getOwnPropertyDescriptor,M=Object.getOwnPropertyNames,z=Object.prototype.hasOwnProperty,Y=(t,e)=>{for(var r in e)u(t,r,{get:e[r],enumerable:!0})},B=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of M(e))!z.call(t,s)&&s!==r&&u(t,s,{get:()=>e[s],enumerable:!(n=J(e,s))||n.enumerable});return t},V=t=>B(u({},"__esModule",{value:!0}),t),v={};Y(v,{Prisma:()=>C,PrismaClient:()=>K,default:()=>G});module.exports=V(v);q={enginesVersion:"2ba551f319ab1df4bc874a89965d8b3641056773"},F="6.19.0",U=F,K=class{constructor(){throw new Error('@prisma/client did not initialize yet. Please run "prisma generate" and try to import it again.')}};C={defineExtension:W,getExtensionContext:$,prismaVersion:{client:U,engine:q.enginesVersion}},G={Prisma:C}});var A=R((oe,_)=>{_.exports={...(g(),m(Q))}});var ne={};k(ne,{cleanupOldEvents:()=>te,getConfig:()=>ee,ingestEvents:()=>Z});module.exports=m(ne);var E=j(A(),1),p;function f(){return p||(p=new E.PrismaClient),p}var o={enabled:process.env.ANALYTICS_ENABLED==="true",requireConsent:process.env.ANALYTICS_REQUIRE_CONSENT!=="false",persistEnabled:process.env.ANALYTICS_PERSIST_ENABLED!=="false",storageDriver:process.env.ANALYTICS_STORAGE_DRIVER||"postgres",retentionDays:parseInt(process.env.ANALYTICS_RETENTION_DAYS||"30",10),allowedEvents:(process.env.ANALYTICS_ALLOWED_EVENTS||"page_view,signup,login,profile_update,media_upload,logout").split(","),samplingRate:parseFloat(process.env.ANALYTICS_SAMPLING_RATE||"1.0"),consentCookie:process.env.ANALYTICS_CONSENT_COOKIE||"analytics_consent",rateLimit:{maxEventsPerWindow:100,windowMinutes:15},maxBatchSize:50,propertyDenylist:["email","password","token","secret","apiKey","api_key","accessToken","access_token","refreshToken","refresh_token","creditCard","credit_card","ssn","social_security","phone","phoneNumber","phone_number","address","ipAddress","ip_address","ip"]};function b(t){return o.allowedEvents.includes(t)}function h(t){if(!t||typeof t!="object")return!1;let e=Object.keys(t).map(r=>r.toLowerCase());return o.propertyDenylist.some(r=>e.some(n=>n.includes(r.toLowerCase())))}function N(t){if(!t||typeof t!="object")return t;let e={...t},r=o.propertyDenylist.map(n=>n.toLowerCase());return Object.keys(e).forEach(n=>{let s=n.toLowerCase();r.some(a=>s.includes(a))&&delete e[n]}),e}var d=new Map;function H(){let t=Date.now(),e=o.rateLimit.windowMinutes*60*1e3;for(let[r,n]of d.entries())t-n.windowStart>e&&d.delete(r)}function X(t){H();let e=Date.now(),r=o.rateLimit.windowMinutes*60*1e3,n=d.get(t);return!n||e-n.windowStart>r?(d.set(t,{count:1,windowStart:e}),!0):n.count>=o.rateLimit.maxEventsPerWindow?!1:(n.count++,!0)}async function Z(t){let e={"Content-Type":"application/json","Access-Control-Allow-Origin":process.env.FRONTEND_URL||"*","Access-Control-Allow-Credentials":"true"};if(!o.enabled)return{statusCode:204,headers:e,body:""};try{let r=JSON.parse(t.body||"{}"),{events:n}=r;if(!Array.isArray(n))return{statusCode:400,headers:e,body:JSON.stringify({error:"Events must be an array"})};if(n.length===0)return{statusCode:400,headers:e,body:JSON.stringify({error:"Events array cannot be empty"})};if(n.length>o.maxBatchSize)return{statusCode:400,headers:e,body:JSON.stringify({error:`Batch size exceeds maximum of ${o.maxBatchSize}`})};let s=[],a=[];for(let c=0;c<n.length;c++){let i=n[c];if(!i.event){a.push({index:c,error:"Missing event name"});continue}if(!b(i.event)){a.push({index:c,error:`Event '${i.event}' not allowed`});continue}if(i.properties&&h(i.properties)){a.push({index:c,error:"Properties contain disallowed keys"});continue}let S=i.properties?N(i.properties):null;s.push({event:i.event,anonId:i.anonId||null,userId:i.userId||null,sessionId:i.sessionId||null,properties:S,createdAt:i.ts?new Date(i.ts):new Date})}let O=n[0]?.anonId||n[0]?.userId||"unknown";if(!X(O))return{statusCode:429,headers:e,body:JSON.stringify({error:"Rate limit exceeded",retryAfter:o.rateLimit.windowMinutes*60})};if(!o.persistEnabled)return{statusCode:202,headers:e,body:JSON.stringify({accepted:s.length,rejected:a.length,persisted:!1})};let y=0;return s.length>0&&(await f().analyticsEvent.createMany({data:s}),y=s.length),{statusCode:a.length>0?207:200,headers:e,body:JSON.stringify({accepted:y,rejected:a.length,errors:a.length>0?a:void 0})}}catch(r){return console.error("Analytics ingest error:",r),{statusCode:500,headers:e,body:JSON.stringify({error:"Internal server error"})}}}async function ee(t){return{statusCode:200,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":process.env.FRONTEND_URL||"*","Access-Control-Allow-Credentials":"true","Cache-Control":"public, max-age=300"},body:JSON.stringify({enabled:o.enabled,requireConsent:o.requireConsent,allowedEvents:o.allowedEvents,samplingRate:o.samplingRate,consentCookie:o.consentCookie})}}async function te(t){let e={"Content-Type":"application/json","Access-Control-Allow-Origin":process.env.FRONTEND_URL||"*","Access-Control-Allow-Credentials":"true"};try{let r=f(),n=new Date;n.setDate(n.getDate()-o.retentionDays);let s=await r.analyticsEvent.deleteMany({where:{createdAt:{lt:n}}});return{statusCode:200,headers:e,body:JSON.stringify({deleted:s.count,cutoffDate:n.toISOString()})}}catch(r){return console.error("Analytics cleanup error:",r),{statusCode:500,headers:e,body:JSON.stringify({error:"Internal server error"})}}}0&&(module.exports={cleanupOldEvents,getConfig,ingestEvents});
