var A=Object.create;var i=Object.defineProperty;var I=Object.getOwnPropertyDescriptor;var S=Object.getOwnPropertyNames;var T=Object.getPrototypeOf,H=Object.prototype.hasOwnProperty;var D=(e,r)=>()=>(e&&(r=e(e=0)),r);var L=(e,r)=>()=>(r||e((r={exports:{}}).exports,r),r.exports),j=(e,r)=>{for(var t in r)i(e,t,{get:r[t],enumerable:!0})},P=(e,r,t,n)=>{if(r&&typeof r=="object"||typeof r=="function")for(let o of S(r))!H.call(e,o)&&o!==t&&i(e,o,{get:()=>r[o],enumerable:!(n=I(r,o))||n.enumerable});return e};var h=(e,r,t)=>(t=e!=null?A(T(e)):{},P(r||!e||!e.__esModule?i(t,"default",{value:e,enumerable:!0}):t,e)),y=e=>P(i({},"__esModule",{value:!0}),e);var $={};function K(e){return typeof e=="function"?e:r=>r.$extends(e)}function W(e){return e}var c,k,B,M,V,q,F,_,U,J,z,G,b,X,O=D(()=>{"use strict";c=Object.defineProperty,k=Object.getOwnPropertyDescriptor,B=Object.getOwnPropertyNames,M=Object.prototype.hasOwnProperty,V=(e,r)=>{for(var t in r)c(e,t,{get:r[t],enumerable:!0})},q=(e,r,t,n)=>{if(r&&typeof r=="object"||typeof r=="function")for(let o of B(r))!M.call(e,o)&&o!==t&&c(e,o,{get:()=>r[o],enumerable:!(n=k(r,o))||n.enumerable});return e},F=e=>q(c({},"__esModule",{value:!0}),e),_={};V(_,{Prisma:()=>b,PrismaClient:()=>G,default:()=>X});module.exports=F(_);U={enginesVersion:"2ba551f319ab1df4bc874a89965d8b3641056773"},J="6.19.0",z=J,G=class{constructor(){throw new Error('@prisma/client did not initialize yet. Please run "prisma generate" and try to import it again.')}};b={defineExtension:K,getExtensionContext:W,prismaVersion:{client:z,engine:U.enginesVersion}},X={Prisma:b}});var N=L((ce,v)=>{v.exports={...(O(),y($))}});var oe={};j(oe,{getPRIntel:()=>ne,ingestPRIntel:()=>te});module.exports=y(oe);var E=h(N(),1),l;function u(){return l||(l=new E.PrismaClient),l}var Q=process.env.FRONTEND_URL||"http://localhost:5173",Y=process.env.NODE_ENV||"development",R=Y==="production",Z=()=>{let e=[Q];return R&&e.push("https://dkmxy676d3vgc.cloudfront.net"),R||e.push("http://localhost:3000","http://localhost:5173"),e},ee=e=>{let r=Z(),t=e?.headers?.origin||e?.headers?.Origin||"";return{"Access-Control-Allow-Origin":r.includes(t)?t:r[0],"Access-Control-Allow-Credentials":"true","Access-Control-Allow-Methods":"GET,POST,PUT,DELETE,PATCH,OPTIONS","Access-Control-Allow-Headers":"Content-Type,Authorization,X-CSRF-Token","Access-Control-Max-Age":"86400"}};function a(e,r=200,t={}){let n=ee(t.event);return delete t.event,{statusCode:r,headers:{"content-type":"application/json",...n,"x-content-type-options":"nosniff","referrer-policy":"strict-origin-when-cross-origin","permissions-policy":"camera=(), microphone=(), geolocation=()","strict-transport-security":"max-age=63072000; includeSubDomains; preload",...t},body:JSON.stringify(e)}}function s(e,r=400,t={}){return a({error:e},r,t)}var p=h(require("crypto"),1),C=process.env.PR_INTEL_ENABLED==="true",w=process.env.PR_INTEL_WEBHOOK_SECRET||"",re=(e,r)=>{if(!w)return console.warn("[PR Intel] No webhook secret configured"),!1;if(!r)return!1;let t=r.split("=");if(t.length!==2||t[0]!=="sha256")return!1;let n=t[1],o=p.default.createHmac("sha256",w).update(e).digest("hex");return p.default.timingSafeEqual(Buffer.from(n),Buffer.from(o))},te=async e=>{try{if(!C)return s("PR Intelligence feature is not enabled",404);let r=e.headers["x-hub-signature-256"]||e.headers["X-Hub-Signature-256"],t=e.body||"";if(!re(t,r))return s("Invalid HMAC signature",403);let n=JSON.parse(t),{prNumber:o,changedFilesCount:d,sensitivePathsCount:f,riskScore:m,metadata:x}=n;if(typeof o!="number"||typeof d!="number"||typeof f!="number"||typeof m!="number")return s("Missing or invalid required fields",400);let g=await u().pRIntelligence.create({data:{prNumber:o,changedFilesCount:d,sensitivePathsCount:f,riskScore:m,metadata:x||null}});return a({message:"PR intelligence ingested successfully",id:g.id,prNumber:g.prNumber},201)}catch(r){return console.error("PR intel ingest error:",r),s("Server error: "+r.message,500)}},ne=async e=>{try{if(!C)return s("PR Intelligence feature is not enabled",404);let{prNumber:r}=e.pathParameters||{};if(!r)return s("prNumber is required",400);let n=await u().pRIntelligence.findMany({where:{prNumber:parseInt(r,10)},orderBy:{createdAt:"desc"}});return n.length===0?s("No PR intelligence found for this PR",404):a({prNumber:parseInt(r,10),records:n,latestRiskScore:n[0].riskScore,totalAnalyses:n.length})}catch(r){return console.error("Get PR intel error:",r),s("Server error: "+r.message,500)}};0&&(module.exports={getPRIntel,ingestPRIntel});
