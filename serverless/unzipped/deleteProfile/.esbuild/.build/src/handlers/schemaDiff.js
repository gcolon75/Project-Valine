var p=Object.defineProperty;var y=Object.getOwnPropertyDescriptor;var g=Object.getOwnPropertyNames;var O=Object.prototype.hasOwnProperty;var N=(o,e)=>{for(var t in e)p(o,t,{get:e[t],enumerable:!0})},S=(o,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of g(e))!O.call(o,s)&&s!==t&&p(o,s,{get:()=>e[s],enumerable:!(r=y(e,s))||r.enumerable});return o};var w=o=>S(p({},"__esModule",{value:!0}),o);var C={};N(C,{analyzeSchemaDiff:()=>b});module.exports=w(C);var k=process.env.FRONTEND_URL||"http://localhost:5173",A=process.env.NODE_ENV||"development",h=A==="production",M=()=>{let o=[k];return h&&o.push("https://dkmxy676d3vgc.cloudfront.net"),h||o.push("http://localhost:3000","http://localhost:5173"),o},T=o=>{let e=M(),t=o?.headers?.origin||o?.headers?.Origin||"";return{"Access-Control-Allow-Origin":e.includes(t)?t:e[0],"Access-Control-Allow-Credentials":"true","Access-Control-Allow-Methods":"GET,POST,PUT,DELETE,PATCH,OPTIONS","Access-Control-Allow-Headers":"Content-Type,Authorization,X-CSRF-Token","Access-Control-Max-Age":"86400"}};function m(o,e=200,t={}){let r=T(t.event);return delete t.event,{statusCode:e,headers:{"content-type":"application/json",...r,"x-content-type-options":"nosniff","referrer-policy":"strict-origin-when-cross-origin","permissions-policy":"camera=(), microphone=(), geolocation=()","strict-transport-security":"max-age=63072000; includeSubDomains; preload",...t},body:JSON.stringify(o)}}function f(o,e=400,t={}){return m({error:o},e,t)}var D=process.env.SCHEMA_DIFF_ENABLED==="true",u=o=>{let e={},t=o.split(`
`),r=null;for(let s of t){let n=s.trim(),i=n.match(/^model\s+(\w+)\s*\{/);if(i){r=i[1],e[r]={fields:{}};continue}if(n==="}"&&r){r=null;continue}if(r&&n&&!n.startsWith("//")&&!n.startsWith("@@")){let l=n.match(/^(\w+)\s+(\S+)/);if(l){let[,a,d]=l;e[r].fields[a]=d}}}return e},E=(o,e)=>{let t=[],r=u(o),s=u(e),n=Object.keys(r),i=Object.keys(s);for(let l of i)r[l]||t.push({type:"addModel",model:l,risk:1});for(let l of n)s[l]||t.push({type:"dropModel",model:l,risk:10});for(let l of i)if(r[l]){let a=r[l].fields,d=s[l].fields;for(let c of Object.keys(d))a[c]?a[c]!==d[c]&&t.push({type:"alterType",model:l,field:c,from:a[c],to:d[c],risk:7}):t.push({type:"addField",model:l,field:c,fieldType:d[c],risk:2});for(let c of Object.keys(a))d[c]||t.push({type:"dropField",model:l,field:c,risk:8})}return t},F=o=>{let e=o.reduce((n,i)=>n+i.risk,0),t=o.some(n=>["dropModel","dropField"].includes(n.type)),r=o.some(n=>n.type==="alterType"),s="low-traffic";return e>50||t?s="scheduled-maintenance":(e>20||r)&&(s="off-peak"),{totalRisk:e,hasDestructive:t,hasTypeChanges:r,windowRecommendation:s,severity:e>50?"high":e>20?"medium":"low"}},b=async o=>{try{if(!D)return f("Schema diff feature is not enabled",404);let e=JSON.parse(o.body||"{}"),{baseSchema:t,targetSchema:r}=e;if(!t||!r)return f("baseSchema and targetSchema are required",400);let s=E(t,r),n=F(s);return m({operations:s,riskScore:n.totalRisk,severity:n.severity,windowRecommendation:n.windowRecommendation,summary:{totalOperations:s.length,addModels:s.filter(i=>i.type==="addModel").length,dropModels:s.filter(i=>i.type==="dropModel").length,addFields:s.filter(i=>i.type==="addField").length,dropFields:s.filter(i=>i.type==="dropField").length,alterTypes:s.filter(i=>i.type==="alterType").length,hasDestructive:n.hasDestructive}})}catch(e){return console.error("Schema diff error:",e),f("Server error: "+e.message,500)}};0&&(module.exports={analyzeSchemaDiff});
