var D=Object.create;var y=Object.defineProperty;var U=Object.getOwnPropertyDescriptor;var b=Object.getOwnPropertyNames;var v=Object.getPrototypeOf,A=Object.prototype.hasOwnProperty;var I=(e,t)=>{for(var s in t)y(e,s,{get:t[s],enumerable:!0})},S=(e,t,s,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of b(t))!A.call(e,r)&&r!==s&&y(e,r,{get:()=>t[r],enumerable:!(o=U(t,r))||o.enumerable});return e};var w=(e,t,s)=>(s=e!=null?D(v(e)):{},S(t||!e||!e.__esModule?y(s,"default",{value:e,enumerable:!0}):s,e)),N=e=>S(y({},"__esModule",{value:!0}),e);var M={};I(M,{runSyntheticJourney:()=>H});module.exports=N(M);var R=process.env.FRONTEND_URL||"http://localhost:5173",$=process.env.NODE_ENV||"development",E=$==="production",P=()=>{let e=[R];return E&&e.push("https://dkmxy676d3vgc.cloudfront.net"),E||e.push("http://localhost:3000","http://localhost:5173"),e},_=e=>{let t=P(),s=e?.headers?.origin||e?.headers?.Origin||"";return{"Access-Control-Allow-Origin":t.includes(s)?s:t[0],"Access-Control-Allow-Credentials":"true","Access-Control-Allow-Methods":"GET,POST,PUT,DELETE,PATCH,OPTIONS","Access-Control-Allow-Headers":"Content-Type,Authorization,X-CSRF-Token","Access-Control-Max-Age":"86400"}};function g(e,t=200,s={}){let o=_(s.event);return delete s.event,{statusCode:t,headers:{"content-type":"application/json",...o,"x-content-type-options":"nosniff","referrer-policy":"strict-origin-when-cross-origin","permissions-policy":"camera=(), microphone=(), geolocation=()","strict-transport-security":"max-age=63072000; includeSubDomains; preload",...s},body:JSON.stringify(e)}}function T(e,t=400,s={}){return g({error:e},t,s)}var f=w(require("crypto"),1),C=w(require("https"),1),k=w(require("http"),1),x=process.env.SYNTHETIC_JOURNEY_ENABLED==="true",O=process.env.API_BASE_URL||"http://localhost:3000",q=process.env.SYNTHETIC_USE_REAL_REQUESTS!=="false",d=(e,t,s=null,o={})=>new Promise((r,n)=>{let i=new URL(t,O),p=i.protocol==="https:",m=p?C.default:k.default,h={method:e,hostname:i.hostname,port:i.port||(p?443:80),path:i.pathname+i.search,headers:{"Content-Type":"application/json","User-Agent":"Valine-Synthetic-Journey/2.0",...o}},l=m.request(h,c=>{let a="";c.on("data",u=>a+=u),c.on("end",()=>{try{let u=a?JSON.parse(a):{};r({statusCode:c.statusCode,headers:c.headers,body:u})}catch{r({statusCode:c.statusCode,headers:c.headers,body:a})}})});l.on("error",c=>n(c)),s&&l.write(JSON.stringify(s)),l.end()}),L=async(e,t)=>{let s=Date.now();try{let o=await t(),r=Date.now()-s;return{step:e,status:"passed",duration:r,result:o}}catch(o){let r=Date.now()-s;return{step:e,status:"failed",duration:r,error:o.message,stack:o.stack}}},j={async register(){let e=Date.now(),t=`synthetic-${e}@valine-test.local`,s=`synthetic${e}`,o=`Synthetic User ${e}`,r=f.default.randomBytes(16).toString("hex"),n=await d("POST","/api/auth/register",{email:t,username:s,displayName:o,password:r});if(n.statusCode!==200&&n.statusCode!==201)throw new Error(`Registration failed: ${n.statusCode} - ${JSON.stringify(n.body)}`);return{email:t,username:s,password:r,userId:n.body.user?.id,verificationToken:n.body.verificationToken}},async verify(e){if(!e.verificationToken)throw new Error("No verification token available");let t=await d("POST","/api/auth/verify-email",{token:e.verificationToken});if(t.statusCode!==200)throw new Error(`Email verification failed: ${t.statusCode}`);return{verified:!0}},async login(e){if(!e.email||!e.password)throw new Error("Email and password required for login");let t=await d("POST","/api/auth/login",{email:e.email,password:e.password});if(t.statusCode!==200)throw new Error(`Login failed: ${t.statusCode}`);let s=t.headers["set-cookie"]||[],o=s.find(n=>n.startsWith("accessToken=")),r=s.find(n=>n.startsWith("refreshToken="));return{loggedIn:!0,userId:t.body.user?.id,accessToken:o?.split(";")[0].split("=")[1],refreshToken:r?.split(";")[0].split("=")[1]}},async createProfile(e){if(!e.accessToken)throw new Error("Access token required for profile creation");let t=await d("POST","/api/profiles",{bio:"Synthetic test profile for observability",location:"Test Environment"},{Cookie:`accessToken=${e.accessToken}`});if(t.statusCode!==200&&t.statusCode!==201)throw new Error(`Profile creation failed: ${t.statusCode}`);return{profileId:t.body.profile?.id||t.body.id}},async uploadMedia(e){if(!e.accessToken)throw new Error("Access token required for media upload");let t=await d("POST","/api/media/presigned-url",{fileName:`synthetic-test-${Date.now()}.jpg`,contentType:"image/jpeg"},{Cookie:`accessToken=${e.accessToken}`});if(t.statusCode!==200)throw new Error(`Media presigned URL request failed: ${t.statusCode}`);return{mediaId:t.body.mediaId,presignedUrl:t.body.url}},async searchSelf(e){if(!e.username)throw new Error("Username required for search");let t=await d("GET",`/api/search/users?q=${encodeURIComponent(e.username)}`);if(t.statusCode!==200)throw new Error(`Search failed: ${t.statusCode}`);return{found:t.body.users?.some(o=>o.username===e.username),resultsCount:t.body.users?.length||0}},async exportData(e){if(!e.accessToken)throw new Error("Access token required for data export");let t=await d("POST","/api/users/export-data",{},{Cookie:`accessToken=${e.accessToken}`});if(t.statusCode!==200&&t.statusCode!==202)throw new Error(`Data export failed: ${t.statusCode}`);return{exportRequested:!0,exportId:t.body.exportId}},async logout(e){if(!e.accessToken)throw new Error("Access token required for logout");let t=await d("POST","/api/auth/logout",{},{Cookie:`accessToken=${e.accessToken}`});if(t.statusCode!==200)throw new Error(`Logout failed: ${t.statusCode}`);return{loggedOut:!0}}},J={async register(){let e=`test-${Date.now()}@example.com`,t=`testuser${Date.now()}`;return{email:e,username:t,simulated:!0}},async verify(e){return{verified:!0,simulated:!0}},async login(e){return{loggedIn:!0,userId:f.default.randomUUID(),simulated:!0}},async createProfile(e){return{profileId:f.default.randomUUID(),simulated:!0}},async uploadMedia(e){return{mediaId:f.default.randomUUID(),simulated:!0}},async searchSelf(e){return{found:!0,simulated:!0}},async exportData(e){return{exportSize:1024,simulated:!0}},async logout(e){return{loggedOut:!0,simulated:!0}}},H=async e=>{try{if(!x)return T("Synthetic journey feature is not enabled",404);let t=JSON.parse(e.body||"{}"),s=t.scenarios||["register","verify","login","createProfile","uploadMedia","searchSelf","exportData","logout"],o=t.mode||(q?"real":"simulated"),r=o==="real"?j:J,n=Date.now(),i=[],p={};for(let a of s)if(r[a]){let u=await L(a,()=>r[a](p));if(i.push(u),u.status==="passed")Object.assign(p,u.result);else break}else{i.push({step:a,status:"failed",duration:0,error:`Unknown scenario: ${a}`});break}let m=Date.now()-n,h=i.filter(a=>a.status==="passed").length,l=i.filter(a=>a.status==="failed").length;return g({journey:{status:l===0?"passed":"failed",mode:o,totalDuration:m,steps:i,summary:{total:i.length,passed:h,failed:l,successRate:Math.round(h/i.length*100)}},metadata:{timestamp:new Date().toISOString(),apiBaseUrl:O,mode:o}})}catch(t){return console.error("Synthetic journey error:",t),T("Server error: "+t.message,500)}};0&&(module.exports={runSyntheticJourney});
