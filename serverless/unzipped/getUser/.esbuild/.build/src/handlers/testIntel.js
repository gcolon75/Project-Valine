var P=Object.create;var l=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var T=Object.getPrototypeOf,w=Object.prototype.hasOwnProperty;var S=(e,t)=>()=>(e&&(t=e(e=0)),t);var D=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),x=(e,t)=>{for(var r in t)l(e,r,{get:t[r],enumerable:!0})},g=(e,t,r,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of R(t))!w.call(e,n)&&n!==r&&l(e,n,{get:()=>t[n],enumerable:!(a=A(t,n))||a.enumerable});return e};var M=(e,t,r)=>(r=e!=null?P(T(e)):{},g(t||!e||!e.__esModule?l(r,"default",{value:e,enumerable:!0}):r,e)),y=e=>g(l({},"__esModule",{value:!0}),e);var $={};function B(e){return typeof e=="function"?e:t=>t.$extends(e)}function J(e){return e}var p,F,k,L,H,U,j,_,V,I,q,G,N,Y,E=S(()=>{"use strict";p=Object.defineProperty,F=Object.getOwnPropertyDescriptor,k=Object.getOwnPropertyNames,L=Object.prototype.hasOwnProperty,H=(e,t)=>{for(var r in t)p(e,r,{get:t[r],enumerable:!0})},U=(e,t,r,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of k(t))!L.call(e,n)&&n!==r&&p(e,n,{get:()=>t[n],enumerable:!(a=F(t,n))||a.enumerable});return e},j=e=>U(p({},"__esModule",{value:!0}),e),_={};H(_,{Prisma:()=>N,PrismaClient:()=>G,default:()=>Y});module.exports=j(_);V={enginesVersion:"2ba551f319ab1df4bc874a89965d8b3641056773"},I="6.19.0",q=I,G=class{constructor(){throw new Error('@prisma/client did not initialize yet. Please run "prisma generate" and try to import it again.')}};N={defineExtension:B,getExtensionContext:J,prismaVersion:{client:q,engine:V.enginesVersion}},Y={Prisma:N}});var h=D((se,O)=>{O.exports={...(E(),y($))}});var ee={};x(ee,{getFlakyCandidates:()=>Z,ingestTestRuns:()=>Q});module.exports=y(ee);var v=M(h(),1),m;function f(){return m||(m=new v.PrismaClient),m}var z=process.env.FRONTEND_URL||"http://localhost:5173",K=process.env.NODE_ENV||"development",b=K==="production",W=()=>{let e=[z];return b&&e.push("https://dkmxy676d3vgc.cloudfront.net"),b||e.push("http://localhost:3000","http://localhost:5173"),e},X=e=>{let t=W(),r=e?.headers?.origin||e?.headers?.Origin||"";return{"Access-Control-Allow-Origin":t.includes(r)?r:t[0],"Access-Control-Allow-Credentials":"true","Access-Control-Allow-Methods":"GET,POST,PUT,DELETE,PATCH,OPTIONS","Access-Control-Allow-Headers":"Content-Type,Authorization,X-CSRF-Token","Access-Control-Max-Age":"86400"}};function d(e,t=200,r={}){let a=X(r.event);return delete r.event,{statusCode:t,headers:{"content-type":"application/json",...a,"x-content-type-options":"nosniff","referrer-policy":"strict-origin-when-cross-origin","permissions-policy":"camera=(), microphone=(), geolocation=()","strict-transport-security":"max-age=63072000; includeSubDomains; preload",...r},body:JSON.stringify(e)}}function o(e,t=400,r={}){return d({error:e},t,r)}var C=process.env.FLAKY_DETECTOR_ENABLED==="true",Q=async e=>{try{if(!C)return o("Flaky test detector feature is not enabled",404);let t=JSON.parse(e.body||"{}"),{tests:r}=t;if(!Array.isArray(r)||r.length===0)return o("tests array is required and must not be empty",400);for(let s of r)if(!s.suite||!s.testName||!s.status||typeof s.durationMs!="number")return o("Each test must have suite, testName, status, and durationMs",400);let n=await f().testRun.createMany({data:r.map(s=>({suite:s.suite,testName:s.testName,status:s.status,durationMs:s.durationMs,metadata:s.metadata||null}))});return d({message:"Test runs ingested successfully",count:n.count},201)}catch(t){return console.error("Test ingest error:",t),o("Server error: "+t.message,500)}},Z=async e=>{try{if(!C)return o("Flaky test detector feature is not enabled",404);let t=parseInt(e.queryStringParameters?.minRuns||"10",10),n=(await f().$queryRaw`
      SELECT 
        suite,
        "testName",
        COUNT(*) as total_runs,
        SUM(CASE WHEN status = 'failed' THEN 1 ELSE 0 END) as failed_runs,
        SUM(CASE WHEN status = 'passed' THEN 1 ELSE 0 END) as passed_runs,
        AVG("durationMs") as avg_duration,
        MAX("runAt") as last_run
      FROM test_runs
      GROUP BY suite, "testName"
      HAVING COUNT(*) >= ${t}
    `).map(s=>{let u=Number(s.total_runs),c=Number(s.failed_runs),i=c/u;return{suite:s.suite,testName:s.testName,totalRuns:u,failedRuns:c,passedRuns:Number(s.passed_runs),failureRate:Math.round(i*1e3)/10,avgDuration:Math.round(Number(s.avg_duration)),lastRun:s.last_run,isFlaky:i>=.2&&i<=.6}}).filter(s=>s.isFlaky).sort((s,u)=>{let c=Math.abs(s.failureRate-50),i=Math.abs(u.failureRate-50);return c-i});return d({flakyCandidates:n,totalCandidates:n.length,minRuns:t,analysisDate:new Date().toISOString()})}catch(t){return console.error("Get flaky candidates error:",t),o("Server error: "+t.message,500)}};0&&(module.exports={getFlakyCandidates,ingestTestRuns});
