# Operations Log - 2025-10-26

## Timeline of Discord Command Registration Issues & Fixes

This log captures incidents, root causes, and remedies for Rin's Discord slash command setup.

---

## Issue 1: 401 Unauthorized

**Timestamp:** Early October 2025  
**Symptom:** API calls to Discord returning `401 Unauthorized`

**Root Cause:**
- Token included the word "Bot " in the environment variable
- OR wrong token was being used

**Fix:**
```powershell
# ❌ WRONG - includes "Bot " prefix
$env:STAGING_DISCORD_BOT_TOKEN = "Bot MTQyODU2ODg0MDk1ODI1MTEwOQ.GxYz..."

# ✅ CORRECT - raw token only
$env:STAGING_DISCORD_BOT_TOKEN = "MTQyODU2ODg0MDk1ODI1MTEwOQ.GxYz..."
```

**Remedy:**
- Use raw token only from Discord Developer Portal
- Script automatically adds "Bot " prefix in Authorization header
- Added validation in `min_register_global.ps1` to catch this

**Prevention:** Script now fails fast if token includes "Bot " prefix

---

## Issue 2: 403 Missing Access (Forbidden)

**Timestamp:** Mid October 2025  
**Symptom:** `403 Forbidden` when registering commands

**Root Cause:**
- App not installed in server with `applications.commands` scope
- OR app missing proper permissions in Discord Developer Portal

**Fix:**
Use correct OAuth2 invite URL shape:
```
https://discord.com/api/oauth2/authorize?client_id=<APP_ID>&scope=bot%20applications.commands&permissions=0&guild_id=<GUILD_ID>&disable_guild_select=true
```

**Remedy:**
- Re-invite bot with both `bot` AND `applications.commands` scopes
- Verify in Discord Developer Portal → OAuth2 → Bot permissions enabled

**Prevention:** Documented exact invite URL shape in troubleshooting guide

---

## Issue 3: 40333 Internal Network Error

**Timestamp:** Intermittent throughout October 2025  
**Symptom:** Discord API returning `40333 internal network error`

**Root Cause:**
- Discord transient network issue (their side)
- Rate limiting on aggressive retry attempts

**Fix:**
- Wait briefly (5-10 seconds)
- Retry the request with exponential backoff
- Avoid hammering the API (respect 429 rate limits)

**Remedy:**
```powershell
# Simple retry with brief pause
Start-Sleep -Seconds 5
.\orchestrator\scripts\min_register_global.ps1
```

**Prevention:** Accept that Discord has flakes; build retry logic into automation

---

## Issue 4: Bot Identity Confusion

**Timestamp:** Late October 2025  
**Symptom:** Wrong bot responding to commands, or commands registered to wrong app

**Root Cause:**
- Two bots in the ecosystem: **Rin** (orchestrator) and **Amadeus** (builder/notifier)
- Environment variables mixed up between the two
- Copy-paste errors with APP_ID and BOT_TOKEN

**Fix:**
**Rin (Orchestrator):**
```
STAGING_DISCORD_APPLICATION_ID = 1428568840958251109
STAGING_DISCORD_BOT_TOKEN = <Rin's token>
```

**Amadeus (Builder/Notifier):**
```
AMADEUS_APPLICATION_ID = <different ID>
AMADEUS_BOT_TOKEN = <different token>
```

**Remedy:**
- Keep env vars clearly named
- Document bot roles in PROJECT_SUMMARY.md
- Use separate config files if needed

**Prevention:** Always verify bot identity with `GET /users/@me` before registration

---

## Issue 5: Global Command Propagation Delay

**Timestamp:** Post-PR-116 (ongoing expected behavior)  
**Symptom:** Command registered successfully but not visible in Discord UI

**Root Cause:**
- Using GLOBAL endpoint (`/applications/{app}/commands`)
- Discord caches and propagates global commands slowly
- Can take up to **~1 hour** for UI to update

**Fix:**
This is NOT a bug - it's the tradeoff for simplicity.

**Remedy:**
- Wait up to 1 hour after registration
- Hard refresh Discord (Ctrl+R) if needed
- Verify registration with API call:
  ```powershell
  iwr -Headers @{Authorization="Bot $env:STAGING_DISCORD_BOT_TOKEN"} `
    https://discord.com/api/v10/applications/$env:STAGING_DISCORD_APPLICATION_ID/commands
  ```

**Future Option:** Switch to guild endpoint for instant visibility (see [NEXT_STEPS.md](NEXT_STEPS.md))

---

## Decision Log: PR #116 Simplification

**Date:** October 2025  
**Decision:** Move from guild-based (instant) to GLOBAL (1hr delay) registration

**Why:**
- Fewer moving parts (no GUILD_ID required)
- Avoids install/permissions confusion
- Easier for agents and humans to understand
- Accept ~1 hour propagation delay as reasonable tradeoff

**What was archived:**
- `archive/_discord_old_scripts/staging_guild_ux_upsert.ps1` - guild registration
- `archive/_discord_old_scripts/register_discord_commands*.sh` - various flows
- `archive/_discord_old_scripts/diagnose_discord_commands.sh` - diagnostics

**Current minimal script:**
- `orchestrator/scripts/min_register_global.ps1` - single source of truth

**Related Files:**
- [docs/discord_min_flow.md](discord_min_flow.md)
- [docs/PROJECT_SUMMARY.md](PROJECT_SUMMARY.md)
- [docs/NEXT_STEPS.md](NEXT_STEPS.md)

---

## Verification Commands

**Check bot identity:**
```powershell
iwr -Headers @{Authorization="Bot $env:STAGING_DISCORD_BOT_TOKEN"} `
  https://discord.com/api/v10/users/@me | % Content
```

**List global commands:**
```powershell
iwr -Headers @{Authorization="Bot $env:STAGING_DISCORD_BOT_TOKEN"} `
  https://discord.com/api/v10/applications/$env:STAGING_DISCORD_APPLICATION_ID/commands | % Content
```

**Register /ux-update:**
```powershell
.\orchestrator\scripts\min_register_global.ps1
```

---

**Log Owner:** DevOps / Rin Operations Team  
**Last Updated:** 2025-10-26  
**Next Review:** When switching to guild-based registration
