# Backend Agent Documentation

## Overview

The Backend Agent is a specialized orchestrator agent that prepares backend-side work required to support UX changes without touching DOM/CSS or visual implementation. It produces human-readable previews, unified diffs, run-check reports, and draft PR payloads. It never merges, runs migrations, or writes to production without explicit human confirmation.

## Primary Responsibilities

- **API Endpoints**: Add/extend API endpoints to support UI features (user preferences, profile links, dashboard stats)
- **Schema Migrations**: Propose schema/model changes and produce migration + backfill plans (but do not run them)
- **Validation**: Add server-side validation, sanitization, and contract tests for new/changed endpoints
- **Draft PRs**: Produce draft PR payloads with focused commits, tests, and documentation
- **Coordination**: Create backend "support PRs" and cross-link to UX agent PRs

## Public API

The BackendAgent exposes four main methods:

### 1. `next_tasks_overview(user: str)`

Get a prioritized list of available backend tasks.

**Parameters:**
- `user` (str): Username requesting the tasks

**Returns:**
```python
{
    'success': True,
    'user': 'username',
    'tasks': [
        {
            'id': 'theme-preference-api',
            'priority': 'High',
            'summary': 'Add GET/PATCH user preference endpoints...',
            'type': 'api-endpoint',
            'requires_migration': True
        },
        # ... more tasks
    ],
    'message': 'Formatted task list with emojis'
}
```

**Example:**
```python
from agents.backend_agent import BackendAgent

agent = BackendAgent(repo="gcolon75/Project-Valine")
result = agent.next_tasks_overview(user='gabriel')
print(result['message'])
```

### 2. `start_task(user: str, task_id: str, context_files: List[str] = None)`

Start a backend task conversation. Returns either clarifying questions or a preview of proposed changes.

**Parameters:**
- `user` (str): Username starting the task
- `task_id` (str): Task identifier from TASK_DEFINITIONS
- `context_files` (List[str], optional): Additional file paths for context

**Returns:**

If clarifications needed:
```python
{
    'success': True,
    'conversation_id': 'uuid-here',
    'needs_clarification': True,
    'questions': [
        'Question 1?',
        'Question 2?'
    ],
    'message': 'Formatted questions'
}
```

If ready for preview:
```python
{
    'success': True,
    'conversation_id': 'uuid-here',
    'task_id': 'task-id',
    'preview': {
        'task_id': 'task-id',
        'summary': 'Task description',
        'files_to_modify': ['file1.js', 'file2.js'],
        'proposed_changes': {...},
        'migration_plan': {...},
        'tests_to_add': [...]
    },
    'message': 'Formatted preview',
    'needs_confirmation': True
}
```

**Example:**
```python
result = agent.start_task(
    user='gabriel',
    task_id='theme-preference-api'
)

if result.get('needs_clarification'):
    print("Questions:", result['questions'])
else:
    print("Preview:", result['message'])
```

### 3. `confirm_and_prepare_pr(conversation_id: str, user_confirmation: str)`

Handle user confirmation and prepare draft PR payload.

**Parameters:**
- `conversation_id` (str): The conversation ID from start_task
- `user_confirmation` (str): User's response ('yes', 'no', or additional feedback)

**Returns:**

If confirmed:
```python
{
    'success': True,
    'draft_pr_payload': {
        'branch': 'autogen/backend/task-id-uuid',
        'title': 'backend: Task summary',
        'body': 'Full PR body with checklists',
        'commits': ['commit message 1', 'commit message 2'],
        'files': ['file1.js', 'file2.js'],
        'labels': ['backend', 'autogenerated', 'api-endpoint'],
        'draft': True
    },
    'message': 'Formatted PR summary'
}
```

**Example:**
```python
result = agent.confirm_and_prepare_pr(
    conversation_id='conv-uuid',
    user_confirmation='yes'
)

if 'draft_pr_payload' in result:
    pr = result['draft_pr_payload']
    print(f"Branch: {pr['branch']}")
    print(f"Commits: {pr['commits']}")
```

### 4. `run_checks(conversation_id: str)`

Run lint, test, and build checks for the proposed changes.

**Parameters:**
- `conversation_id` (str): The conversation ID

**Returns:**
```python
{
    'success': True,
    'all_passed': True,
    'lint': {
        'passed': True,
        'command': 'npm run lint',
        'output': 'All files pass linting',
        'warnings': 0,
        'errors': 0
    },
    'tests': {
        'passed': True,
        'command': 'npm test',
        'output': 'All tests passing',
        'total': 42,
        'passed': 42,
        'failed': 0
    },
    'build': {
        'passed': True,
        'command': 'npm run build',
        'output': 'Build completed successfully',
        'size': '1.2 MB'
    },
    'message': 'Formatted check results'
}
```

**Example:**
```python
result = agent.run_checks(conversation_id='conv-uuid')
print(f"All checks passed: {result['all_passed']}")
print(result['message'])
```

## Available Tasks

The BackendAgent includes the following predefined tasks:

### High Priority

#### `theme-preference-api`
Add GET/PATCH user preference endpoints for theme, propose schema migration, migration/backfill plan, tests, and docs.
- **Type**: api-endpoint
- **Requires Migration**: Yes
- **Files**: server/routes/users.js, api/prisma/schema.prisma

#### `profile-links-titles`
Add title and links contract for user profile, validation, and migration proposal.
- **Type**: api-endpoint
- **Requires Migration**: Yes
- **Files**: server/routes/users.js, api/prisma/schema.prisma

#### `validators-and-security`
Add robust validators and sanitizers for new inputs; add tests and error formats.
- **Type**: validation
- **Requires Migration**: No
- **Files**: server/routes/helpers.js

### Medium Priority

#### `dashboard-stats-endpoints`
Create aggregate endpoints for total views/engagement and caching guidance.
- **Type**: api-endpoint
- **Requires Migration**: No
- **Files**: server/routes/stats.js

#### `migrations-and-backfills`
Produce migration scripts with dry-run and rollback steps; do not execute without approval.
- **Type**: migration
- **Requires Migration**: Yes
- **Files**: api/prisma/migrations/

#### `contract-tests-and-ci`
Add contract tests and ensure CI runs them.
- **Type**: testing
- **Requires Migration**: No
- **Files**: server/__tests__/

## Safety Constraints

The Backend Agent follows these safety principles:

1. **No Destructive Operations**: Never perform DB migrations, backfills, or production writes without human confirmation and a documented maintenance plan.

2. **Small, Focused Commits**: Always produce small, focused commits with clear messages.

3. **Separate Migration PRs**: If a task requires a schema change, produce a separate migration PR (draft) and do not mix UI-only commits in the same PR.

4. **Run Checks First**: Run lint/tests/build locally and report failures; do not prepare a PR with failing checks.

5. **Explicit Confirmation Required**: Require explicit confirmation before creating branches or draft PRs with write-enabled tokens.

## Draft PR Structure

Every draft PR includes:

### PR Body Sections
- **Summary**: Motivation and high-level changes
- **Files Modified/Created**: High-level list
- **Migration Plan**: If applicable, with rollback steps
- **Testing Checklist**: Unit tests, integration tests, lint, build
- **Manual QA Steps**: How to exercise endpoints and verify changes
- **Coordination**: Cross-link to UX agent PR or conversation ID
- **Reviewers**: Backend owner, frontend/UX owner

### Commit Naming Convention
```
feat(api): add user preferences endpoints (GET/PATCH)
feat(schema): add theme field to User model
test(api): add contract tests for preferences endpoints
docs: add API documentation for user preferences
```

### Branch Naming Convention
```
autogen/backend/<task-slug>-<shortid>
```
Example: `autogen/backend/profile-links-9f3a`

## Workflow Examples

### Example 1: Simple Task (No Clarifications)

```python
from agents.backend_agent import BackendAgent

# Initialize
agent = BackendAgent(repo="gcolon75/Project-Valine")

# Get task overview
overview = agent.next_tasks_overview(user='gabriel')
print(overview['message'])

# Start task
result = agent.start_task(
    user='gabriel',
    task_id='validators-and-security'
)

conversation_id = result['conversation_id']
print(result['message'])  # Preview of changes

# Run checks
checks = agent.run_checks(conversation_id=conversation_id)
print(checks['message'])

# Confirm and prepare PR
if checks['all_passed']:
    pr_result = agent.confirm_and_prepare_pr(
        conversation_id=conversation_id,
        user_confirmation='yes'
    )
    
    pr = pr_result['draft_pr_payload']
    print(f"Ready to create PR on branch: {pr['branch']}")
```

### Example 2: Task with Clarifications

```python
# Start task that needs clarifications
result = agent.start_task(
    user='gabriel',
    task_id='theme-preference-api'
)

if result.get('needs_clarification'):
    print("Questions to answer:")
    for q in result['questions']:
        print(f"  - {q}")
    
    # User would answer questions, then you'd call start_task again
    # with answers provided in context_files or proceed to confirm
```

### Example 3: Providing Additional Feedback

```python
# Start task
result = agent.start_task(user='gabriel', task_id='dashboard-stats-endpoints')
conversation_id = result['conversation_id']

# Provide feedback instead of yes/no
feedback = agent.confirm_and_prepare_pr(
    conversation_id=conversation_id,
    user_confirmation='Can we also add caching headers?'
)

print(feedback['message'])  # Agent acknowledges feedback

# Later, confirm when ready
final = agent.confirm_and_prepare_pr(
    conversation_id=conversation_id,
    user_confirmation='yes'
)
```

## Integration with UX Agent

The Backend Agent is designed to work in coordination with the UX Agent:

1. **Backend Agent**: Creates API endpoints, schema changes, validation, tests
2. **UX Agent**: Implements frontend UI that consumes those APIs

**Coordination Pattern:**
- Backend Agent creates PR: `autogen/backend/profile-api-<id>`
- UX Agent creates PR: `autogen/ux/profile-ui-<id>`
- Each PR includes cross-reference to the other in PR body
- Both PRs reviewed and merged together

## Architecture

### Class Structure

```
BackendAgent
├── TASK_DEFINITIONS: Dict of available tasks
├── conversations: In-memory conversation store
├── github_service: Optional GitHub service for PR operations
└── Methods:
    ├── next_tasks_overview()
    ├── start_task()
    ├── confirm_and_prepare_pr()
    ├── run_checks()
    └── Helper methods for formatting and generation

ConversationState
├── conversation_id
├── user_id
├── task_id
├── task_details
├── proposed_changes
├── migration_plan
├── check_results
└── to_dict() / from_dict() for persistence
```

### Conversation State Management

Currently uses in-memory storage. In production, would use DynamoDB with TTL for conversation persistence:

```python
# Production implementation would use:
import boto3
dynamodb = boto3.resource('dynamodb')
conversations_table = dynamodb.Table('backend-agent-conversations')

# Store with 1-hour TTL
from datetime import timedelta
ttl = int((datetime.now(timezone.utc) + timedelta(hours=1)).timestamp())
conversations_table.put_item(
    Item={**conversation.to_dict(), 'ttl': ttl}
)
```

## Testing

The BackendAgent includes comprehensive tests in `tests/test_backend_agent.py`:

- **23 tests** covering all major functionality
- **Test categories**:
  - ConversationState initialization and serialization
  - Task overview and priority ordering
  - Task starting with/without clarifications
  - PR confirmation and preparation
  - Check execution
  - Full workflow integration tests

Run tests:
```bash
cd orchestrator
python3 -m unittest tests.test_backend_agent -v
```

## Future Enhancements

1. **Real Check Execution**: Replace mock check implementations with actual npm/lint/test commands
2. **DynamoDB Integration**: Add conversation persistence to DynamoDB
3. **GitHub PR Creation**: Integrate with GitHub API to automatically create draft PRs
4. **Migration Execution**: Add safe migration execution with dry-run and rollback
5. **Task Customization**: Allow dynamic task creation and modification
6. **Multi-repo Support**: Extend to support multiple repositories
7. **Async Task Processing**: Add support for long-running tasks

## Troubleshooting

### Conversation Not Found
If you get "Conversation not found or expired":
- Conversations are stored in memory and cleared after confirmation/cancellation
- Each start_task creates a new conversation with unique ID
- Save the conversation_id from start_task result for later use

### Task ID Not Found
If you get "Unknown task ID":
- Check available tasks with `next_tasks_overview()`
- Task IDs are defined in `BackendAgent.TASK_DEFINITIONS`
- Use exact task ID string (e.g., 'theme-preference-api', not 'theme preference api')

### Checks Failing
If checks fail:
- Review the check output in the returned results
- Fix issues in code before confirming PR
- Re-run checks after fixes with same conversation_id

## References

- [Backend Agent Specification](.github/agents/backendAgent.md)
- [UX Agent Documentation](ux_agent.md)
- [Agent Registry](../app/agents/registry.py)
- [Example Usage](../examples/backend_agent_example.py)
- [Test Suite](../tests/test_backend_agent.py)
