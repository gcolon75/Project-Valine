name: Analyze Orchestration Run

on:
  workflow_run:
    workflows: ["Orchestrate Verification and Sweep"]
    types:
      - completed

permissions:
  actions: read
  contents: read

jobs:
  analyze:
    name: Analyze Orchestration Results
    runs-on: ubuntu-latest
    # Only run if the secret is configured, grant PR write permission
    permissions:
      actions: read
      contents: read
      pull-requests: ${{ secrets.ORCHESTRATION_BOT_PAT != '' && 'write' || 'none' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run orchestration analyzer
        id: analyze
        run: |
          node scripts/analyze-orchestration-run.mjs ${{ github.event.workflow_run.id }} \
            --out-dir analysis-output \
            --json \
            --summary $GITHUB_STEP_SUMMARY \
            --fail-on P0
        continue-on-error: true
      
      - name: Upload analysis report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: CONSOLIDATED_ANALYSIS_REPORT
          path: analysis-output/
          retention-days: 30
      
      - name: Post PR comment with analysis results
        if: github.event.workflow_run.event == 'pull_request' && secrets.ORCHESTRATION_BOT_PAT != ''
        uses: actions/github-script@v7
        env:
          GITHUB_TOKEN: ${{ secrets.ORCHESTRATION_BOT_PAT }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Read the summary JSON
            let summaryData;
            try {
              const summaryPath = path.join('analysis-output', 'summary.json');
              summaryData = JSON.parse(fs.readFileSync(summaryPath, 'utf8'));
            } catch (error) {
              console.log('Could not read summary.json, skipping PR comment');
              return;
            }
            
            // Get PR number from workflow_run
            const prNumber = context.payload.workflow_run.pull_requests[0]?.number;
            if (!prNumber) {
              console.log('No PR context found, skipping comment');
              return;
            }
            
            // Build severity counts
            const p0Count = summaryData.issues?.p0?.length || 0;
            const p1Count = summaryData.issues?.p1?.length || 0;
            const p2Count = summaryData.issues?.p2?.length || 0;
            const p3Count = summaryData.issues?.p3?.length || 0;
            
            // Determine gating decision
            let gatingDecision = 'âœ… **PROCEED**';
            let gatingIcon = 'âœ…';
            if (p0Count > 0) {
              gatingDecision = 'ðŸš« **BLOCK**';
              gatingIcon = 'ðŸš«';
            } else if (p1Count > 3) {
              gatingDecision = 'âš ï¸ **CAUTION**';
              gatingIcon = 'âš ï¸';
            }
            
            // Build artifact link
            const runId = context.payload.workflow_run.id;
            const artifactLink = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;
            
            // Build comment body parts
            const header = '## ' + gatingIcon + ' Orchestration Analysis Results';
            const decision = '**Gating Decision:** ' + gatingDecision;
            const issueSummary = '### Issue Summary\n- **P0 (Critical):** ' + p0Count + ' ðŸ”´\n- **P1 (Serious):** ' + p1Count + ' ðŸŸ \n- **P2 (Moderate):** ' + p2Count + ' ðŸŸ¡\n- **P3 (Minor):** ' + p3Count + ' âšª';
            const detailsSection = '### Details\n- **Workflow Run:** [#' + runId + '](' + artifactLink + ')\n- **Analysis Report:** [Download Artifact](' + artifactLink + ')';
            const warnings = [
              p0Count > 0 ? 'âš ï¸ **Critical issues (P0) must be resolved before merging.**' : '',
              p1Count > 3 ? 'âš ï¸ **Multiple serious issues (P1) detected. Review recommended.**' : ''
            ].filter(w => w).join('\n');
            
            const commentBody = [header, '', decision, '', issueSummary, '', detailsSection, warnings ? '\n' + warnings : '', '', '---', '*Generated by orchestration analyzer*'].join('\n');
            
            // Post comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: commentBody
            });
      
      - name: Check analysis result
        if: steps.analyze.outcome == 'failure'
        run: |
          echo "::error::Orchestration analysis failed - critical issues (P0) detected"
          exit 1
