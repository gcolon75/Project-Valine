name: Secret Hygiene

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]
  workflow_dispatch:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  secret-scan:
    name: Scan for Secrets
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better scanning
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Run Secret Audit
        id: audit
        run: |
          echo "Running secret audit..."
          node scripts/secret-audit.mjs --json > secret-audit-results.json || true
          
          # Check if any secrets found
          if jq -e '.count > 0' secret-audit-results.json > /dev/null; then
            echo "secrets_found=true" >> $GITHUB_OUTPUT
            echo "::warning::Potential secrets detected in repository"
          else
            echo "secrets_found=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload Audit Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: secret-audit-results
          path: secret-audit-results.json
          retention-days: 30
      
      - name: Comment on PR (if secrets found)
        if: steps.audit.outputs.secrets_found == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('secret-audit-results.json', 'utf8'));
            
            const criticalCount = results.bySeverity?.critical?.length || 0;
            const highCount = results.bySeverity?.high?.length || 0;
            const mediumCount = results.bySeverity?.medium?.length || 0;
            const lowCount = results.bySeverity?.low?.length || 0;
            
            let body = '## âš ï¸ Secret Scan Results\n\n';
            body += `**Total Findings:** ${results.count}\n\n`;
            
            if (criticalCount > 0) {
              body += `ðŸ”´ **Critical:** ${criticalCount}\n`;
            }
            if (highCount > 0) {
              body += `ðŸŸ  **High:** ${highCount}\n`;
            }
            if (mediumCount > 0) {
              body += `ðŸŸ¡ **Medium:** ${mediumCount}\n`;
            }
            if (lowCount > 0) {
              body += `âšª **Low:** ${lowCount}\n`;
            }
            
            body += '\n### Action Required\n\n';
            body += 'Potential secrets were detected in this PR. Please review the findings:\n\n';
            body += '1. Remove any actual secrets from the code\n';
            body += '2. Add false positives to `.secret-allowlist`\n';
            body += '3. Rotate any exposed secrets immediately\n\n';
            body += 'Download the full audit results from the workflow artifacts for details.\n';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
      
      - name: Fail if critical secrets found
        if: steps.audit.outputs.secrets_found == 'true'
        run: |
          echo "::error::Secret scan detected potential secrets in the repository"
          echo "Review the audit results and fix before merging"
          exit 1
  
  gitleaks-scan:
    name: Gitleaks Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
        continue-on-error: true
      
      - name: Upload Gitleaks Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: results.sarif
          retention-days: 30
          if-no-files-found: ignore

  env-contract-validation:
    name: Environment Contract Validation
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [development, staging, production]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Set Environment Variables
        run: |
          # Set NODE_ENV for validation
          echo "NODE_ENV=${{ matrix.environment }}" >> $GITHUB_ENV
          
          # Set required variables based on environment
          if [ "${{ matrix.environment }}" == "production" ]; then
            echo "JWT_SECRET=production-secret-validation-test-32chars" >> $GITHUB_ENV
            echo "DATABASE_URL=postgresql://user:pass@host:5432/db" >> $GITHUB_ENV
            echo "FRONTEND_URL=https://example.com" >> $GITHUB_ENV
            echo "ALLOWED_USER_EMAILS=test@example.com" >> $GITHUB_ENV
          elif [ "${{ matrix.environment }}" == "staging" ]; then
            echo "JWT_SECRET=staging-secret-validation-test-32chars" >> $GITHUB_ENV
            echo "DATABASE_URL=postgresql://user:pass@host:5432/db" >> $GITHUB_ENV
            echo "FRONTEND_URL=https://staging.example.com" >> $GITHUB_ENV
          else
            echo "DATABASE_URL=postgresql://localhost:5432/valine_dev" >> $GITHUB_ENV
          fi
      
      - name: Run Environment Contract Validation
        run: |
          echo "Validating ${{ matrix.environment }} environment contract..."
          node scripts/verify-env-contract.mjs
      
      - name: Upload Validation Results
        if: always()
        run: |
          node scripts/verify-env-contract.mjs --json > env-validation-${{ matrix.environment }}.json || true
      
      - name: Upload Results Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: env-validation-${{ matrix.environment }}
          path: env-validation-${{ matrix.environment }}.json
          retention-days: 30

  summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [secret-scan, gitleaks-scan, env-contract-validation]
    if: always()
    
    steps:
      - name: Generate Summary
        run: |
          echo "# ðŸ”’ Secret Hygiene Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Audit | ${{ needs.secret-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Gitleaks | ${{ needs.gitleaks-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Env Contract | ${{ needs.env-contract-validation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
